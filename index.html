<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Reaction Planner</title>
    <!-- v4.0: Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS Variables & Reset ===== */
        :root {
        /* üß™ v4.0 Lab Theme Colors */
        --primary: #0f766e;           /* Teal 700 */
        --primary-hover: #0d9488;     /* Teal 600 */
        --primary-light: rgba(15, 118, 110, 0.1);

        --bg-body: #f8fafc;           /* Slate 50 */
        --bg-card: #ffffff;
        --text-main: #0f172a;         /* Slate 900 */
        --text-muted: #64748b;        /* Slate 500 */
        --border-color: #e2e8f0;      /* Slate 200 */

        /* üö¶ Status Colors (High Contrast) */
        --success-bg: #dcfce7;
        --success-text: #14532d;
        --success-border: #86efac;
        --warning-bg: #fef9c3;
        --warning-text: #713f12;
        --warning-border: #fde047;
        --danger-bg: #fee2e2;
        --danger-text: #7f1d1d;
        --danger-border: #fca5a5;

        /* Legacy compatibility */
        --primary-color: var(--primary);
        --error-color: #dc2626;
        --success-color: #16a34a;
        --background: var(--bg-card);

        /* üìè Spacing & Sizing */
        --input-height: 48px;
        --radius-sm: 6px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

        /* üî§ Typography */
        --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        --font-mono: 'Roboto Mono', ui-monospace, monospace;
        --font-family: var(--font-ui);

        /* Legacy */
        --card-shadow: var(--shadow-md);
        --limiting-reagent-bg: #f0fdfa;
        --table-header-bg: #f8fafc;
    }

    /* üåô Dark Mode Support */
    @media (prefers-color-scheme: dark) {
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #ffffff;          /* v4.1: Pure white for max contrast */
            --text-muted: #cbd5e1;          /* v4.1: Brighter muted text */
            --border-color: #334155;

            --primary: #14b8a6;
            --primary-hover: #2dd4bf;
            --primary-light: rgba(20, 184, 166, 0.15);

            --success-bg: #052e16;
            --success-text: #86efac;
            --warning-bg: #422006;
            --warning-text: #fde047;
            --danger-bg: #450a0a;
            --danger-text: #fca5a5;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --limiting-reagent-bg: #042f2e;
            --table-header-bg: #1e293b;
        }

        /* v4.2: Canvas always white for copy/paste compatibility */
        .compound-canvas, .reagent-canvas {
            background-color: #ffffff !important;
        }

        /* v4.2: Enhanced text contrast for dark mode */
        .section-title, .card-title, h2, h3, h4, .card-header {
            color: #f1f5f9 !important;
        }

        label, .data-label, .card-field label {
            color: #cbd5e1 !important;
        }

        /* v4.3: Dark mode input readability fix */
        input, select, textarea {
            background-color: #334155 !important; /* Slate-700 Ê∑±ÁÅ∞Â∫ï */
            color: #ffffff !important;
            border: 1px solid #475569 !important;
        }

        input::placeholder, textarea::placeholder {
            color: #94a3b8 !important;
        }

        /* v4.3: Button text contrast */
        .fetch-btn, .reagent-fetch-btn, button {
            color: #ffffff !important;
        }

        .badge, .role-badge {
            color: #000 !important;
            font-weight: 700;
        }

        /* v4.3: Canvas always white for Word paste */
        canvas, .compound-canvas, .reagent-canvas {
            background-color: #ffffff !important;
        }
    }

        * {
            box-sizing: border-box;
        }

        body {
        font-family: var(--font-ui);
        background-color: var(--bg-body);
        margin: 0;
        padding: 20px;
        color: var(--text-main);
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

        /* ===== Layout ===== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            gap: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        h1 {
        color: var(--text-main);
        margin: 0;
        font-size: 28px;
        font-weight: 600;
    }

        h2 {
        color: var(--text-main);
        margin: 0 0 15px 0;
        font-size: 20px;
        font-weight: 600;
    }

        /* ===== Card & Section Styles ===== */
        .card {
        background: var(--bg-card);
        border: none;
        border-radius: var(--radius-lg);
        padding: 24px;
        box-shadow: var(--shadow-md);
    }

        /* ===== Reaction Scheme Section ===== */
        .reaction-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .molecule-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 280px;
        }

        .molecule-container label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .molecule-container input {
            width: 100%;
            margin-bottom: 10px;
        }

        canvas {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            max-width: 100%;
            height: auto;
        }

        canvas.error {
            border-color: var(--error-color);
            border-width: 2px;
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            min-height: 16px;
            margin-top: 4px;
        }

        .arrow-container {
            font-size: 48px;
            color: #333;
            font-weight: bold;
            margin: 0 10px;
        }

        /* ===== Form Elements ===== */
        input[type="text"],
        input[type="number"],
        textarea {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-family);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        input.error {
            border-color: var(--error-color);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        input[type="text"].smiles-input {
            font-family: monospace;
        }

        input[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: var(--font-family);
        }

        button:hover {
        background-color: var(--primary-hover);
    }

    button:active {
        transform: scale(0.98);
    }

        button:active {
            background-color: #004494;
        }

        button.success {
            background-color: var(--success-color);
        }

        button.success:hover {
            background-color: #1e7e34;
        }

        button.remove-btn {
            background-color: var(--error-color);
            padding: 6px 12px;
            font-size: 12px;
        }

        button.remove-btn:hover {
            background-color: #c82333;
        }

        #exportBtn {
            background-color: var(--success-color);
        }

        #exportBtn:hover {
            background-color: #1e7e34;
        }

        /* ===== Table Styles ===== */
        .table-controls {
            margin-bottom: 15px;
        }

        #stoich-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #stoich-table thead {
            background: var(--table-header-bg);
            font-weight: 600;
        }

        #stoich-table th,
        #stoich-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        #stoich-table th {
            font-size: 14px;
            color: #555;
        }

        #stoich-table td {
            font-size: 14px;
        }

        .limiting-reagent {
            background: var(--limiting-reagent-bg);
            font-weight: 500;
        }

        #stoich-table input[type="text"],
        #stoich-table input[type="number"] {
            width: 100%;
            max-width: 150px;
            padding: 6px 10px;
            font-size: 13px;
        }

        #stoich-table input.reagent-name {
            max-width: 200px;
        }

        .reagent-mmol {
            font-weight: 500;
            color: #333;
        }

        /* ===== Type-specific field visibility (Updated v1.1) ===== */
        
        /* General Input Sizing */
        #stoich-table input[type="number"] {
            min-width: 80px;
        }

        /* 1. Pure Solid: Show Mass, Purity */
        .reagent-row[data-type="pure-solid"] .reagent-mass,
        .reagent-row[data-type="pure-solid"] .reagent-purity { display: inline-block; }
        
        .reagent-row[data-type="pure-solid"] .reagent-volume,
        .reagent-row[data-type="pure-solid"] .reagent-molarity,
        .reagent-row[data-type="pure-solid"] .reagent-density { display: none; }

        /* 2. Pure Liquid: Show Volume, Density, Purity */
        .reagent-row[data-type="pure-liquid"] .reagent-volume,
        .reagent-row[data-type="pure-liquid"] .reagent-density,
        .reagent-row[data-type="pure-liquid"] .reagent-purity { display: inline-block; }
        
        .reagent-row[data-type="pure-liquid"] .reagent-mass,
        .reagent-row[data-type="pure-liquid"] .reagent-molarity { display: none; }

        /* 3. Solution (Molarity): Show Volume, Molarity */
        .reagent-row[data-type="solution-molarity"] .reagent-volume,
        .reagent-row[data-type="solution-molarity"] .reagent-molarity { display: inline-block; }
        
        .reagent-row[data-type="solution-molarity"] .reagent-mass,
        .reagent-row[data-type="solution-molarity"] .reagent-density,
        .reagent-row[data-type="solution-molarity"] .reagent-purity { display: none; }

        /* 4. Solution (Wt%): Show Volume, Density, Purity */
        .reagent-row[data-type="solution-density"] .reagent-volume,
        .reagent-row[data-type="solution-density"] .reagent-density,
        .reagent-row[data-type="solution-density"] .reagent-purity { display: inline-block; }
        
        .reagent-row[data-type="solution-density"] .reagent-mass,
        .reagent-row[data-type="solution-density"] .reagent-molarity { display: none; }

        /* N/A Placeholder Logic */
        .field-na { display: none; color: #aaa; user-select: none; }
        
        /* Pure Solid needs N/A in Molarity/Density col */
        .reagent-row[data-type="pure-solid"] td:nth-child(8) .field-na { display: inline-block; }
        
        /* Solution Molarity needs N/A in Purity col */
        .reagent-row[data-type="solution-molarity"] td:nth-child(9) .field-na { display: inline-block; }

        /* Hide N/A placeholder in Molarity/Density column when molarity input is active */
        .reagent-row[data-type="solution-molarity"] td:nth-child(8) .field-na { display: none; }

        /* Dropdown styling */
        .reagent-type {
            width: 100%;
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-family);
            background-color: white;
            cursor: pointer;
        }

        .reagent-type:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* ===== CAS Input Group & Fetch Button ===== */
        .cas-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .cas-input {
            flex: 1;
            min-width: 100px;
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .cas-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .fetch-btn {
            padding: 6px 12px;
            font-size: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s;
        }

        .fetch-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .fetch-btn:active:not(:disabled) {
            background-color: #004494;
        }

        .fetch-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.65;
        }

        .fetch-btn.loading {
            background-color: #ffc107;
            color: #000;
        }

        /* ===== Conditions Section ===== */
        .conditions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ===== v2.1 Conditions Vertical Layout ===== */
        .conditions-vertical {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .condition-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .condition-row label {
            flex: 0 0 160px;
            font-weight: 500;
            font-size: 14px;
            color: #333;
        }

        .condition-row input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: 14px;
            max-width: 300px;
        }

        .condition-row input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .condition-row input[readonly] {
            background: #f8f9fa;
            color: #666;
        }

        .condition-row-with-btn .input-with-btn {
            display: flex;
            gap: 8px;
            flex: 1;
            max-width: 300px;
        }

        .condition-row-with-btn .input-with-btn input {
            flex: 1;
            max-width: none;
        }

        .condition-row-with-btn .fetch-btn {
            padding: 10px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .condition-row-with-btn .fetch-btn:hover {
            background: #0056b3;
        }

        .condition-row-with-btn .fetch-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .condition-row-with-btn .fetch-btn.loading {
            background: #6c757d;
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 768px) {
            .reaction-display {
                flex-direction: column;
            }

            .arrow-container {
                transform: rotate(90deg);
            }

            h1 {
                font-size: 22px;
            }

            header {
                flex-direction: column;
                gap: 10px;
            }

            #stoich-table {
                font-size: 12px;
            }

            #stoich-table th,
            #stoich-table td {
                padding: 8px;
            }

            /* Stack solvent calculator vertically on mobile */
            .solvent-calculator {
                grid-template-columns: 1fr;
            }
        }

        /* ===== v1.4 Êñ∞Â¢ûÊ®£Âºè ===== */
        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .clear-btn {
            background-color: var(--error-color);
            color: white;
        }

        .clear-btn:hover {
            background-color: #c82333;
        }

        .clear-btn:active {
            background-color: #a71d2a;
        }

        .reagent-canvas {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: #ffffff !important;
            width: 100% !important;
            height: 150px !important;  /* v4.2: Fixed height for reagents */
        }

        .reagent-structure-cell {
            text-align: center;
            vertical-align: middle;
        }

        /* ===== Print Media Queries ===== */
        /* Legacy print styles removed - see v2.1 Print Styles below */

        /* Structure Visualization v1.3 */
        .warning-box {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        .force-visible { display: block !important; }
        .force-hidden { display: none !important; }

        /* ===== v2.1 Reaction Scheme Card Layout ===== */
        .reaction-scheme-container {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            overflow-x: auto;
            padding: 20px 15px;
            min-height: 400px;
        }

        .compound-card {
            flex: 0 0 280px;
            min-width: 280px;
            max-width: 300px;
            background: var(--background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .compound-card.sm-card {
            background: var(--limiting-reagent-bg);
            border-color: #b8d4e8;
        }

        .compound-card .card-header {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compound-card .card-header input.reagent-name {
            flex: 1;
            font-weight: 600;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 14px;
            padding: 0;
        }

        .compound-card .card-header input.reagent-name:focus {
            outline: none;
            border-bottom: 1px solid var(--primary-color);
        }

        .compound-canvas {
        width: 100% !important;
        max-width: 100%;
        height: 200px !important;      /* v4.2: Fixed height */
        display: block;
        margin: 0 auto 15px auto;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background-color: #ffffff !important; /* v4.2: Always white for Word paste */
        object-fit: contain;
    }

        /* ===== v3.0: Limiting Reagent Badge ===== */
        .limiting-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: linear-gradient(135deg, #ffd700 0%, #ffb700 100%);
            color: #333;
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(255, 183, 0, 0.3);
        }

        .compound-card.is-limiting {
            border: 2px solid #ffd700;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        .compound-card.is-limiting .card-header {
            background: linear-gradient(180deg, #fffbe6 0%, transparent 100%);
        }

        /* ===== v3.0: Yield Display System ===== */
        .yield-display {
            margin-top: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .yield-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .yield-progress-container {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .yield-progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 6px;
            transition: width 0.3s ease, background-color 0.3s ease;
            background: #6c757d;
        }

        .yield-percentage {
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            color: #333;
        }

        /* Traffic Light Colors */
        .yield-display.yield-excellent .yield-progress-bar {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }
        .yield-display.yield-excellent .yield-percentage {
            color: #28a745;
        }

        .yield-display.yield-good .yield-progress-bar {
            background: linear-gradient(90deg, #ffc107 0%, #fd7e14 100%);
        }
        .yield-display.yield-good .yield-percentage {
            color: #856404;
        }

        .yield-display.yield-poor .yield-progress-bar {
            background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
        }
        .yield-display.yield-poor .yield-percentage {
            color: #dc3545;
        }

        /* ===== v3.0: GHS Safety Icons ===== */
        .ghs-icons {
            display: inline-flex;
            gap: 2px;
            font-size: 16px;
            margin-left: auto;
            padding-left: 8px;
            cursor: help;
            position: relative;
        }

        .ghs-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            margin-top: 4px;
        }

        .ghs-icons:hover .ghs-tooltip {
            display: block;
        }

        .card-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-field label {
            font-size: 12px;
            font-weight: 600;           /* v4.1: Bolder for better visibility */
            color: var(--text-muted);   /* v4.1: Use variable for dark mode support */
        }

        .card-field input,
        .card-field select {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            width: 100%;
            box-sizing: border-box;
        }

        .card-field .fixed-value {
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }

        .card-field .reagent-mmol {
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .reagent-card .remove-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-width: auto;
        }

        .reagent-card .remove-btn:hover {
            background: #c82333;
        }

        .scheme-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #666;
            min-width: 40px;
            align-self: center;
        }

        .reagent-cards-container {
            display: flex;
            gap: 20px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 5px;
        }

        .scheme-controls {
            margin-bottom: 15px;
        }

        /* Card-based Type-specific field visibility */
        .reagent-row .reagent-mass-field,
        .reagent-row .reagent-volume-field,
        .reagent-row .reagent-molarity-field,
        .reagent-row .reagent-density-field,
        .reagent-row .reagent-purity-field { display: none; }

        .reagent-row[data-type="pure-solid"] .reagent-mass-field,
        .reagent-row[data-type="pure-solid"] .reagent-purity-field { display: flex; }

        .reagent-row[data-type="pure-liquid"] .reagent-volume-field,
        .reagent-row[data-type="pure-liquid"] .reagent-density-field,
        .reagent-row[data-type="pure-liquid"] .reagent-purity-field { display: flex; }

        .reagent-row[data-type="solution-molarity"] .reagent-volume-field,
        .reagent-row[data-type="solution-molarity"] .reagent-molarity-field { display: flex; }

        .reagent-row[data-type="solution-density"] .reagent-volume-field,
        .reagent-row[data-type="solution-density"] .reagent-density-field,
        .reagent-row[data-type="solution-density"] .reagent-purity-field { display: flex; }

        /* Responsive design for card layout */
        @media (max-width: 768px) {
            .reaction-scheme-container {
                flex-direction: column;
                align-items: center;
            }

            .scheme-arrow {
                transform: rotate(90deg);
            }

            .compound-card {
                flex: 0 0 280px;
                min-width: 280px;
                max-width: 280px;
            }

            .reagent-cards-container {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Print styles for card layout */
        /* ===== v2.1 Print Styles - A4 Landscape ===== */
        @page {
            size: A4 landscape;
            margin: 10mm;
        }

        @media print {
            /* Page setup */
            body {
                font-size: 11px;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            /* Card layout for printing */
            .reaction-scheme-container {
                flex-wrap: wrap;
                justify-content: flex-start;
                gap: 10px;
                padding: 10px 0;
                overflow: visible;
            }

            .compound-card {
                flex: 0 0 200px;
                min-width: 200px;
                max-width: 200px;
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
                padding: 10px;
                gap: 8px;
            }

            .reagent-cards-container {
                flex-wrap: wrap;
                overflow: visible;
                gap: 10px;
            }

            /* Hide interactive elements */
            .reagent-card .remove-btn,
            .scheme-controls,
            .fetch-btn,
            #solvent-fetch-btn,
            #clearAllBtn,
            #exportBtn,
            .header-buttons {
                display: none !important;
            }

            /* Document-style input fields */
            .compound-card input,
            .compound-card select,
            .condition-row input,
            .condition-row select,
            #notes {
                border: none !important;
                border-bottom: 1px solid #999 !important;
                border-radius: 0 !important;
                background: transparent !important;
                box-shadow: none !important;
                padding: 4px 2px !important;
                font-size: 11px;
            }

            .compound-card input[readonly],
            .condition-row input[readonly] {
                border-bottom-style: dotted !important;
            }

            /* Conditions section print optimization */
            .conditions-vertical {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px 20px;
            }

            .condition-row {
                gap: 8px;
            }

            .condition-row label {
                flex: 0 0 120px;
                font-size: 11px;
            }

            .condition-row input {
                max-width: none;
            }

            .condition-row-with-btn .input-with-btn {
                max-width: none;
            }

            /* Canvas size for print */
            .compound-canvas {
                height: 100px !important;
                max-width: 180px;
            }

            /* Reduce section spacing */
            .card {
                padding: 10px;
                margin-bottom: 10px;
            }

            /* Header adjustments */
            header {
                margin-bottom: 10px;
            }

            h1 {
                font-size: 20px;
                margin-bottom: 5px;
            }

            h2 {
                font-size: 14px;
                margin-bottom: 8px;
            }

            /* Scheme arrow size */
            .scheme-arrow {
                font-size: 18px;
                min-width: 30px;
            }

            /* Notes textarea */
            #notes {
                min-height: 40px;
                resize: none;
            }

            /* Card field labels */
            .card-field label {
                font-size: 10px;
            }

            .card-field input,
            .card-field select {
                font-size: 11px;
                padding: 4px 6px !important;
            }

            /* v3.0 Print Styles */
            .limiting-badge {
                background: #ffd700;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .yield-display {
                border: 1px solid #333;
            }

            .yield-progress-bar {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .ghs-icons {
                font-size: 12px;
            }

            .ghs-tooltip {
                display: none !important;
            }
        }

        /* ===== v4.3: Toast Notifications ===== */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #1e293b;
            color: #ffffff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: toastSlideIn 0.3s ease-out;
            max-width: 350px;
            font-size: 14px;
        }

        .toast.success { background: #16a34a; }
        .toast.error { background: #dc2626; }
        .toast.warning { background: #d97706; }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ===== v4.3: Loading Button State ===== */
        .btn-loading {
            opacity: 0.7 !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Digital Reaction Planner</h1>
            <div class="header-buttons">
                <button id="clearAllBtn" class="clear-btn" aria-label="Clear all data and reset">Clear All</button>
                <button id="saveBtn" aria-label="Save experiment as JSON file">üíæ Save JSON</button>
                <button id="loadBtn" aria-label="Load experiment from JSON file">üìÇ Load JSON</button>
                <button id="exportBtn" aria-label="Print reaction plan">üñ®Ô∏è Print</button>
            </div>
            <input type="file" id="fileInput" accept=".json" style="display: none;">
        </header>

        <!-- v2.0 Reaction Scheme Section (Card Layout) -->
        <section id="reaction-scheme-section" class="card">
            <h2>Reaction Scheme</h2>
            <div class="scheme-controls">
                <button id="add-reagent" aria-label="Add new reagent">+ Add Reagent</button>
            </div>
            <div class="reaction-scheme-container">
                <!-- Starting Material Card -->
                <div class="compound-card sm-card" id="sm-card">
                    <div class="card-header">Starting Material</div>
                    <canvas id="sm-canvas" class="compound-canvas" width="450" height="300" role="img" aria-label="Starting material molecular structure"></canvas>
                    <div class="card-field">
                        <label for="sm-smiles">SMILES</label>
                        <input type="text" id="sm-smiles" class="smiles-input" placeholder="SMILES notation">
                    </div>
                    <span class="error-message" id="sm-error"></span>
                    <div id="sm-stereo-warning" class="warning-box" style="display: none;">
                        ‚ö†Ô∏è Stereochemistry warning
                    </div>
                    <div class="card-field">
                        <label for="sm-cas">CAS No.</label>
                        <div class="cas-input-group">
                            <input type="text" id="sm-cas" placeholder="CAS No." class="cas-input" aria-label="Starting Material CAS Number">
                            <button id="sm-fetch-btn" class="fetch-btn" aria-label="Fetch data from PubChem">Fetch</button>
                        </div>
                    </div>
                    <div class="card-field">
                        <label for="sm-mw">MW (g/mol)</label>
                        <input type="number" id="sm-mw" step="0.01" min="0" placeholder="MW" aria-label="Starting Material Molecular Weight">
                    </div>
                    <div class="card-field">
                        <label>Equivalents</label>
                        <span class="fixed-value">1.00</span>
                    </div>
                    <div class="card-field">
                        <label for="sm-mmol">Amount (mmol)</label>
                        <input type="number" id="sm-mmol" step="0.001" readonly placeholder="Calculated" aria-label="Starting Material Amount in mmol" aria-readonly="true">
                    </div>
                    <div class="card-field">
                        <label for="sm-mass">Mass (mg)</label>
                        <input type="number" id="sm-mass" step="0.1" min="0" placeholder="Mass" aria-label="Starting Material Mass in mg">
                    </div>
                </div>

                <div class="scheme-arrow">+</div>

                <!-- Reagent Cards Container -->
                <div class="reagent-cards-container" id="reagent-cards">
                    <!-- Dynamic reagent cards will be added here -->
                </div>

                <div class="scheme-arrow">‚Üí</div>

                <!-- Product Card -->
                <div class="compound-card product-card" id="product-card">
                    <div class="card-header">Product</div>
                    <canvas id="product-canvas" class="compound-canvas" width="450" height="300" role="img" aria-label="Product molecular structure"></canvas>
                    <div class="card-field">
                        <label for="product-smiles">SMILES</label>
                        <input type="text" id="product-smiles" class="smiles-input" placeholder="SMILES notation">
                    </div>
                    <span class="error-message" id="product-error"></span>
                    <div id="product-stereo-warning" class="warning-box" style="display: none;">
                        ‚ö†Ô∏è Stereochemistry warning
                    </div>
                    <div class="card-field">
                        <label for="product-cas">CAS No.</label>
                        <div class="cas-input-group">
                            <input type="text" id="product-cas" placeholder="CAS No." class="cas-input" aria-label="Product CAS Number">
                            <button id="product-fetch-btn" class="fetch-btn" aria-label="Fetch product data from PubChem">Fetch</button>
                        </div>
                    </div>
                    <!-- v3.0: MW and Yield fields -->
                    <div class="card-field">
                        <label for="product-mw">MW (g/mol)</label>
                        <input type="number" id="product-mw" step="0.01" min="0" placeholder="From CAS or manual">
                    </div>
                    <div class="card-field">
                        <label>Theoretical Yield (mg)</label>
                        <span id="product-theoretical" class="fixed-value">-</span>
                    </div>
                    <div class="card-field">
                        <label for="product-actual">Actual Mass (mg)</label>
                        <input type="number" id="product-actual" step="0.01" min="0" placeholder="Enter actual yield">
                    </div>
                    <!-- v3.0: Traffic Light Yield Display -->
                    <div class="yield-display" id="yield-display">
                        <div class="yield-label">Yield</div>
                        <div class="yield-progress-container">
                            <div class="yield-progress-bar" id="yield-bar"></div>
                        </div>
                        <div class="yield-percentage" id="yield-percentage">--%</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Conditions Section -->
        <section id="conditions-section" class="card">
            <h2>Conditions & Notes</h2>
            <div class="conditions-vertical">
                <div class="condition-row">
                    <label for="solvent-name">Solvent Name</label>
                    <input type="text" id="solvent-name" placeholder="e.g., THF, DCM">
                </div>
                <div class="condition-row condition-row-with-btn">
                    <label for="solvent-cas">Solvent CAS</label>
                    <div class="input-with-btn">
                        <input type="text" id="solvent-cas" placeholder="e.g., 109-99-9">
                        <button type="button" id="solvent-fetch-btn" class="fetch-btn">Fetch</button>
                    </div>
                </div>
                <div class="condition-row">
                    <label for="solvent-bp">Solvent BP. (¬∞C)</label>
                    <input type="text" id="solvent-bp" placeholder="Auto-filled or manual" readonly>
                </div>
                <div class="condition-row">
                    <label for="solvent-conc">Target Conc. (M)</label>
                    <input type="number" id="solvent-conc" step="0.01" min="0" placeholder="0.1">
                </div>
                <div class="condition-row">
                    <label for="solvent-volume">Solvent Volume (mL)</label>
                    <input type="number" id="solvent-volume" readonly placeholder="Auto-calculated">
                </div>
                <div class="condition-row">
                    <label for="temperature">Reaction Temp.</label>
                    <input type="text" id="temperature" placeholder="e.g., 25¬∞C, rt, reflux">
                </div>
                <div class="condition-row">
                    <label for="time">Reaction Time</label>
                    <input type="text" id="time" placeholder="e.g., 2 h, overnight">
                </div>
            </div>
            <!-- v3.2: Procedure Checklist -->
            <div class="procedure-section">
                <div class="procedure-header">
                    <h3>Procedure Checklist</h3>
                    <span id="procedure-progress" class="progress-badge">0/0</span>
                </div>

                <div class="procedure-input-group">
                    <input type="text" id="new-step-input" placeholder="Add a new step (e.g., Mix reagents, Heat to 80¬∞C)...">
                    <button id="add-step-btn" type="button">Add Step</button>
                </div>

                <ul id="procedure-list" class="procedure-list">
                    <!-- ÂãïÊÖãÁîüÊàêÁöÑÊ≠•È©üÈ†ÖÁõÆ -->
                </ul>
            </div>
        </section>
    </div>

    <!-- External Library -->
    <script src="https://unpkg.com/smiles-drawer@1.2.0/dist/smiles-drawer.min.js"></script>

    <script>
        /**
         * Digital Reaction Planner
         * A tool for calculating stoichiometry and planning chemistry reactions
         *
         * Features:
         * - SMILES structure rendering for starting materials and products
         * - Automatic stoichiometry calculations (mass ‚Üî mmol ‚Üî equivalents)
         * - Bidirectional calculation support (forward and reverse)
         * - Dynamic reagent table management
         * - Print/export functionality
         */

        // ===== Global State & Configuration =====

        // Central data model - single source of truth for all reaction data
        const reactionPlan = {
            startingMaterial: {
                smiles: '',
                mw: 0,
                mass: 0,
                mmol: 0,
                cas: '',
                ghsData: null  // v3.0: GHS safety data
            },
            product: {
                smiles: '',
                cas: '',
                mw: 0,
                name: '',
                theoreticalYield: 0,  // v3.0: Theoretical yield in mg
                actualMass: 0,        // v3.0: Actual mass in mg
                percentYield: 0,      // v3.0: Percent yield
                ghsData: null         // v3.0: GHS safety data
            },
            reagents: [],  // Each reagent now has: role, ghsData
            conditions: {
                solventName: '',
                solventCAS: '',
                solventBP: '',
                solventConc: 0,
                solventVolume: 0,
                temperature: '',
                time: '',
                steps: []  // v3.2: Procedure checklist { id, text, isDone, observation }
            },
            limitingReagent: null  // v3.0: ID of limiting reagent ('sm' or reagent id)
        };

        let reagentCounter = 0;
        let drawer = null;

        // ===== Utility Functions =====

        // Debounce function to prevent excessive re-renders
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===== SMILES Rendering Module =====

        // Initialize SmilesDrawer with academic configuration
        function initializeSmilesDrawer() {
            drawer = new SmilesDrawer.Drawer({
                width: 450,
                height: 300,
                bondThickness: 2.0,         // v4.3: Bolder lines
                bondLength: 40,             // v4.3: Larger bonds to fill canvas
                shortBondLength: 0.8,
                bondSpacing: 7.2,           // 0.18 * 40
                atomVisualization: 'default',
                isomeric: true,
                debug: false,
                terminalCarbons: true,
                explicitHydrogens: false,
                overlapSensitivity: 0.42,
                overlapResolutionIterations: 1,
                compactDrawing: false,
                fontSizeLarge: 12,
                fontSizeSmall: 8,
                padding: 20,
                themes: {
                    dark: {
                        C: '#000000',
                        O: '#000000',
                        N: '#000000',
                        F: '#000000',
                        CL: '#000000',
                        BR: '#000000',
                        I: '#000000',
                        P: '#000000',
                        S: '#000000',
                        B: '#000000',
                        SI: '#000000',
                        H: '#000000',
                        BACKGROUND: '#ffffff'
                    }
                }
            });
        }

        // Clear canvas
        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // Draw structure from SMILES (v1.3 with stereo detection)
        function drawStructure(smiles, canvasId, errorElementId) {
            const canvas = document.getElementById(canvasId);
            const errorElement = document.getElementById(errorElementId);

            // Get warning box element
            const warningId = canvasId.replace('-canvas', '-stereo-warning');
            const warningBox = document.getElementById(warningId);

            // Clean input and detect stereochemistry
            const cleanSmiles = smiles ? smiles.trim() : '';
            const hasStereo = cleanSmiles.includes('@');

            // Handle stereochemistry warning
            if (warningBox) {
                if (hasStereo) {
                    warningBox.classList.add('force-visible');
                    warningBox.classList.remove('force-hidden');
                    warningBox.style.display = 'block';
                } else {
                    warningBox.classList.add('force-hidden');
                    warningBox.classList.remove('force-visible');
                    warningBox.style.display = 'none';
                }
            }

            if (!cleanSmiles) {
                clearCanvas(canvasId);
                canvas.classList.remove('error');
                if (errorElement) errorElement.textContent = '';
                canvas.setAttribute('aria-label', 'Empty chemical structure canvas');
                return;
            }

            try {
                SmilesDrawer.parse(cleanSmiles, function(tree) {
                    // Success - draw structure
                    clearCanvas(canvasId);
                    drawer.draw(tree, canvas, 'dark', false);
                    canvas.classList.remove('error');
                    if (errorElement) errorElement.textContent = '';
                    canvas.setAttribute('aria-label', `molecular structure: ${cleanSmiles}`);
                }, function(err) {
                    // Error - show feedback
                    console.error('SMILES parsing error:', err);
                    clearCanvas(canvasId);
                    canvas.classList.add('error');
                    if (errorElement) errorElement.textContent = 'Invalid SMILES notation';
                });
            } catch (error) {
                console.error('Drawing error:', error);
                clearCanvas(canvasId);
                canvas.classList.add('error');
                if (errorElement) errorElement.textContent = 'Error rendering structure';
            }
        }

        // ===== Reagent Small Structure Drawing =====
        let miniDrawer = null;

        function initializeMiniDrawer() {
            miniDrawer = new SmilesDrawer.Drawer({
                width: 450,
                height: 300,
                bondThickness: 2.0,         // v4.3: Bolder
                bondLength: 40,             // v4.3: Fill canvas
                shortBondLength: 0.8,
                bondSpacing: 7.2,
                atomVisualization: 'default',
                isomeric: true,
                debug: false,
                terminalCarbons: true,
                explicitHydrogens: false,
                overlapSensitivity: 0.42,
                overlapResolutionIterations: 1,
                compactDrawing: false,
                fontSizeLarge: 12,
                fontSizeSmall: 8,
                padding: 20,
                themes: {
                    dark: {
                        C: '#000000',
                        O: '#000000',
                        N: '#000000',
                        F: '#000000',
                        CL: '#000000',
                        BR: '#000000',
                        I: '#000000',
                        P: '#000000',
                        S: '#000000',
                        B: '#000000',
                        SI: '#000000',
                        H: '#000000',
                        BACKGROUND: '#ffffff'
                    }
                }
            });
        }

        function drawReagentStructure(smiles, canvas) {
            if (!smiles || !canvas) return;
            if (!miniDrawer) initializeMiniDrawer();

            const cleanSmiles = smiles.trim();
            if (!cleanSmiles) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            try {
                SmilesDrawer.parse(cleanSmiles, function(tree) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    miniDrawer.draw(tree, canvas, 'dark', false);
                    console.log('[Reagent Draw] Structure drawn for:', cleanSmiles);
                }, function(err) {
                    console.error('[Reagent Draw] SMILES parsing error:', err);
                });
            } catch (error) {
                console.error('[Reagent Draw] Drawing error:', error);
            }
        }

        // ===== Data Model Updates =====

        function updateStartingMaterialData() {
            reactionPlan.startingMaterial.smiles = document.getElementById('sm-smiles').value;
            reactionPlan.startingMaterial.mw = parseFloat(document.getElementById('sm-mw').value) || 0;
            reactionPlan.startingMaterial.mass = parseFloat(document.getElementById('sm-mass').value) || 0;
            reactionPlan.startingMaterial.cas = document.getElementById('sm-cas').value || '';
        }

        function updateProductData() {
            reactionPlan.product.smiles = document.getElementById('product-smiles').value;
        }

        function updateConditionsData() {
            reactionPlan.conditions.solventName = document.getElementById('solvent-name').value;
            reactionPlan.conditions.solventCAS = document.getElementById('solvent-cas').value;
            reactionPlan.conditions.solventBP = document.getElementById('solvent-bp').value;
            reactionPlan.conditions.solventConc = parseFloat(document.getElementById('solvent-conc').value) || 0;
            reactionPlan.conditions.solventVolume = parseFloat(document.getElementById('solvent-volume').value) || 0;
            reactionPlan.conditions.temperature = document.getElementById('temperature').value;
            reactionPlan.conditions.time = document.getElementById('time').value;
            // v3.2: notes removed, steps managed by addStep/toggleStep/removeStep
        }

        // ===== Clear All Data Function =====

        /**
         * Clear all data and reset the application
         * Shows confirmation dialog before proceeding
         */
        function clearAllData() {
            const confirmed = confirm(
                'Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâË≥áÊñôÂóéÔºüÊ≠§Âãï‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ'
            );

            if (confirmed) {
                try {
                    // Clear LocalStorage
                    localStorage.removeItem('reactionPlanData');
                    console.log('[Clear All] LocalStorage cleared');

                    // Reload page to reset all state
                    window.location.reload();
                } catch (error) {
                    console.error('[Clear All] Error during reset:', error);
                    alert('Error occurred while clearing data. Please try refreshing the page manually.');
                }
            }
        }

        // ===== LocalStorage Persistence Module =====

        /**
         * Save all current form data to localStorage
         */
        function saveToLocalStorage() {
            try {
                // Collect Starting Material data
                const startingMaterial = {
                    cas: document.getElementById('sm-cas').value || '',
                    mw: document.getElementById('sm-mw').value || '',
                    mass: document.getElementById('sm-mass').value || '',
                    smiles: document.getElementById('sm-smiles').value || '',
                    ghsData: reactionPlan.startingMaterial.ghsData || null  // v3.0
                };

                // Collect all reagent rows
                const reagents = [];
                const reagentRows = document.querySelectorAll('.reagent-row');
                reagentRows.forEach(row => {
                    const reagentData = {
                        id: row.dataset.reagentId,
                        name: row.querySelector('.reagent-name').value || '',
                        cas: row.querySelector('.reagent-cas').value || '',
                        type: row.querySelector('.reagent-type').value || 'pure-solid',
                        role: row.querySelector('.reagent-role') ? row.querySelector('.reagent-role').value : 'reagent',  // v3.0
                        mw: row.querySelector('.reagent-mw').value || '',
                        eq: row.querySelector('.reagent-eq').value || '1.0',
                        mass: row.querySelector('.reagent-mass').value || '',
                        volume: row.querySelector('.reagent-volume').value || '',
                        molarity: row.querySelector('.reagent-molarity').value || '',
                        density: row.querySelector('.reagent-density').value || '',
                        purity: row.querySelector('.reagent-purity').value || '',
                        smiles: row.dataset.smiles || ''
                    };
                    reagents.push(reagentData);
                });

                // Collect Conditions data
                const conditions = {
                    solventName: document.getElementById('solvent-name').value || '',
                    solventCAS: document.getElementById('solvent-cas').value || '',
                    solventBP: document.getElementById('solvent-bp').value || '',
                    solventConc: document.getElementById('solvent-conc').value || '',
                    temperature: document.getElementById('temperature').value || '',
                    time: document.getElementById('time').value || '',
                    steps: reactionPlan.conditions.steps || []  // v3.2: Procedure checklist
                };

                // Collect Product data
                const product = {
                    smiles: document.getElementById('product-smiles').value || '',
                    cas: document.getElementById('product-cas').value || '',
                    mw: document.getElementById('product-mw').value || '',
                    name: reactionPlan.product.name || '',
                    theoreticalYield: reactionPlan.product.theoreticalYield || 0,  // v3.0
                    actualMass: document.getElementById('product-actual').value || '',  // v3.0
                    percentYield: reactionPlan.product.percentYield || 0,  // v3.0
                    ghsData: reactionPlan.product.ghsData || null  // v3.0
                };

                // Package all data
                const dataToSave = {
                    startingMaterial,
                    reagents,
                    conditions,
                    product,
                    reagentCounter,  // Save the counter to maintain unique IDs
                    limitingReagent: reactionPlan.limitingReagent  // v3.0
                };

                // Save to localStorage
                localStorage.setItem('reactionPlanData', JSON.stringify(dataToSave));
                console.log('[Auto-Save] Data saved to localStorage');
            } catch (error) {
                console.error('[Auto-Save] Error saving to localStorage:', error);
            }
        }

        /**
         * Restore reaction plan from data object
         * v3.1: Extracted from loadFromLocalStorage for reuse with JSON import
         * @param {Object} data - The reaction plan data object
         */
        function restoreReactionPlan(data) {
            // Clear existing reagent rows before restoring
            const existingRows = document.querySelectorAll('.reagent-row');
            existingRows.forEach(row => row.remove());
            reactionPlan.reagents = [];

            // Restore Starting Material
            if (data.startingMaterial) {
                document.getElementById('sm-cas').value = data.startingMaterial.cas || '';
                document.getElementById('sm-mw').value = data.startingMaterial.mw || '';
                document.getElementById('sm-mass').value = data.startingMaterial.mass || '';
                document.getElementById('sm-smiles').value = data.startingMaterial.smiles || '';
            }

            // Restore reagentCounter to maintain unique IDs
            if (data.reagentCounter !== undefined) {
                reagentCounter = data.reagentCounter;
            }

            // Restore Reagents (create rows dynamically)
            if (data.reagents && data.reagents.length > 0) {
                data.reagents.forEach(reagentData => {
                    // Create new reagent row with basic data
                    const row = addReagentRow(reagentData.name, reagentData.mw, reagentData.eq);

                    // Populate all fields
                    row.querySelector('.reagent-cas').value = reagentData.cas || '';
                    row.querySelector('.reagent-type').value = reagentData.type || 'pure-solid';
                    row.querySelector('.reagent-mw').value = reagentData.mw || '';
                    row.querySelector('.reagent-eq').value = reagentData.eq || '1.0';
                    row.querySelector('.reagent-mass').value = reagentData.mass || '';
                    row.querySelector('.reagent-volume').value = reagentData.volume || '';
                    row.querySelector('.reagent-molarity').value = reagentData.molarity || '';
                    row.querySelector('.reagent-density').value = reagentData.density || '';
                    row.querySelector('.reagent-purity').value = reagentData.purity || '';

                    // Update row's data-type attribute for CSS visibility
                    row.dataset.type = reagentData.type || 'pure-solid';

                    // v3.0: Restore role
                    const roleSelect = row.querySelector('.reagent-role');
                    if (roleSelect && reagentData.role) {
                        roleSelect.value = reagentData.role;
                    }

                    // Update the reagent ID to match saved ID (maintain consistency)
                    row.dataset.reagentId = reagentData.id;

                    // Restore and draw reagent SMILES
                    if (reagentData.smiles) {
                        row.dataset.smiles = reagentData.smiles;
                        const canvas = row.querySelector('.reagent-canvas');
                        if (canvas) {
                            drawReagentStructure(reagentData.smiles, canvas);
                        }
                    }

                    // Update data model
                    const reagentId = reagentData.id;
                    updateReagentInModel(reagentId, row);
                });
            }

            // Restore Conditions
            if (data.conditions) {
                document.getElementById('solvent-name').value = data.conditions.solventName || '';
                document.getElementById('solvent-cas').value = data.conditions.solventCAS || '';
                document.getElementById('solvent-bp').value = data.conditions.solventBP || '';
                document.getElementById('solvent-conc').value = data.conditions.solventConc || '';
                document.getElementById('temperature').value = data.conditions.temperature || '';
                document.getElementById('time').value = data.conditions.time || '';

                // v3.2 Migration: Handle notes ‚Üí steps conversion
                if (data.conditions.steps && Array.isArray(data.conditions.steps)) {
                    // New format: use steps directly
                    reactionPlan.conditions.steps = data.conditions.steps;
                } else if (data.conditions.notes && typeof data.conditions.notes === 'string' && data.conditions.notes.trim()) {
                    // Old format: convert notes to first step
                    reactionPlan.conditions.steps = [{
                        id: `step-migrated-${Date.now()}`,
                        text: data.conditions.notes.trim(),
                        isDone: false,
                        observation: ''
                    }];
                    console.log('[Migration] Converted notes to steps:', data.conditions.notes);
                } else {
                    // Empty data
                    reactionPlan.conditions.steps = [];
                }

                renderProcedure();
            }

            // Restore Product
            if (data.product) {
                document.getElementById('product-smiles').value = data.product.smiles || '';
                document.getElementById('product-cas').value = data.product.cas || '';

                // v3.0: Restore MW and yield fields
                const mwValue = data.product.mw || '';
                document.getElementById('product-mw').value = mwValue;
                reactionPlan.product.mw = parseFloat(mwValue) || 0;
                reactionPlan.product.name = data.product.name || '';

                // v3.0: Restore actual mass
                if (data.product.actualMass) {
                    document.getElementById('product-actual').value = data.product.actualMass;
                    reactionPlan.product.actualMass = parseFloat(data.product.actualMass) || 0;
                }

                // v3.0: Restore GHS data
                if (data.product.ghsData) {
                    reactionPlan.product.ghsData = data.product.ghsData;
                    displayGHSPictograms('product-card', data.product.ghsData);
                }
            }

            // v3.0: Restore limitingReagent
            if (data.limitingReagent) {
                reactionPlan.limitingReagent = data.limitingReagent;
            }

            // Update all data models
            updateStartingMaterialData();
            updateProductData();
            updateConditionsData();

            // Trigger calculations after restoration
            calculateSMMmol();  // This will cascade to reagents and solvent volume

            // v3.0: Trigger limiting reagent and yield calculations
            determineLimitingReagent();
            calculatePercentYield();

            // Draw restored structures
            if (data.startingMaterial && data.startingMaterial.smiles) {
                drawStructure(data.startingMaterial.smiles, 'sm-canvas', 'sm-error');
            }
            if (data.product && data.product.smiles) {
                drawStructure(data.product.smiles, 'product-canvas', 'product-error');
            }

            console.log('[Restore] Data restoration complete');
        }

        /**
         * Load saved data from localStorage and populate form
         * @returns {boolean} - True if data was loaded, false otherwise
         */
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('reactionPlanData');

                if (!savedData) {
                    console.log('[Auto-Restore] No saved data found');
                    return false;
                }

                const data = JSON.parse(savedData);
                console.log('[Auto-Restore] Loading saved data:', data);

                restoreReactionPlan(data);

                return true;
            } catch (error) {
                console.error('[Auto-Restore] Error loading from localStorage:', error);
                return false;
            }
        }

        // ===== Stoichiometry Calculation Module =====

        // Calculate SM mmol from mass and MW
        function calculateSMMmol() {
            const mass = parseFloat(document.getElementById('sm-mass').value) || 0;
            const mw = parseFloat(document.getElementById('sm-mw').value) || 0;

            if (mass > 0 && mw > 0) {
                // Formula: mmol = (mass in mg / MW) * 1000
                const mmol = (mass / mw);
                reactionPlan.startingMaterial.mmol = mmol;
                document.getElementById('sm-mmol').value = mmol.toFixed(4);

                // Recalculate all reagents when SM mmol changes
                recalculateAllReagents();
                // Recalculate solvent volume when SM mmol changes
                calculateSolventVolume();
                // v3.0: Recalculate limiting reagent
                determineLimitingReagent();
            } else {
                reactionPlan.startingMaterial.mmol = 0;
                document.getElementById('sm-mmol').value = '';
                recalculateAllReagents();
                calculateSolventVolume();
                // v3.0: Recalculate limiting reagent
                determineLimitingReagent();
            }
        }

        // Calculate required solvent volume from SM mmol and target concentration
        function calculateSolventVolume() {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const targetConc = parseFloat(document.getElementById('solvent-conc').value) || 0;
            const volumeInput = document.getElementById('solvent-volume');

            if (smMmol > 0 && targetConc > 0) {
                // Formula: Volume (mL) = mmol / Molarity (M)
                const volume = smMmol / targetConc;
                volumeInput.value = volume.toFixed(3);

                // Update data model
                reactionPlan.conditions.solventVolume = volume;
            } else {
                volumeInput.value = '';
                reactionPlan.conditions.solventVolume = 0;
            }
        }

        // Calculation dispatcher - routes to appropriate calculation based on reagent type
        function calculateReagent(reagentRow, direction = 'forward') {
            const typeSelect = reagentRow.querySelector('.reagent-type');
            const type = typeSelect ? typeSelect.value : 'pure-solid';

            if (type === 'pure-solid') {
                return direction === 'forward' 
                    ? calculatePureSolidMass(reagentRow) 
                    : calculatePureSolidEquivalents(reagentRow);
            } else if (type === 'pure-liquid') {
                return direction === 'forward' 
                    ? calculatePureLiquidVolume(reagentRow) 
                    : calculatePureLiquidEquivalents(reagentRow);
            } else if (type === 'solution-molarity') {
                return direction === 'forward' 
                    ? calculateMolarityVolume(reagentRow) 
                    : calculateMolarityEquivalents(reagentRow);
            } else if (type === 'solution-density') {
                return direction === 'forward' 
                    ? calculateDensityVolume(reagentRow) 
                    : calculateDensityEquivalents(reagentRow);
            }
        }

        // 1. Pure Solid Calculation (Mass = mmol * MW / Purity)
        function calculatePureSolidMass(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const mw = parseFloat(reagentRow.querySelector('.reagent-mw').value) || 0;
            const eq = parseFloat(reagentRow.querySelector('.reagent-eq').value) || 0;
            const purity = parseFloat(reagentRow.querySelector('.reagent-purity').value) || 100;
            
            const massInput = reagentRow.querySelector('.reagent-mass');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && mw > 0 && eq >= 0 && purity > 0) {
                const targetMmol = smMmol * eq;
                const theoreticalMass = targetMmol * mw; 
                const realMass = theoreticalMass / (purity / 100); 

                mmolDisplay.textContent = targetMmol.toFixed(3);
                massInput.value = realMass.toFixed(2); 

                return { mmol: targetMmol, mass: realMass };
            }
            return { mmol: 0, mass: 0 };
        }

        function calculatePureSolidEquivalents(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const mw = parseFloat(reagentRow.querySelector('.reagent-mw').value) || 0;
            const mass = parseFloat(reagentRow.querySelector('.reagent-mass').value) || 0;
            const purity = parseFloat(reagentRow.querySelector('.reagent-purity').value) || 100;
            
            const eqInput = reagentRow.querySelector('.reagent-eq');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && mw > 0 && mass > 0 && purity > 0) {
                const theoreticalMass = mass * (purity / 100);
                const reagentMmol = theoreticalMass / mw;
                const eq = reagentMmol / smMmol;

                mmolDisplay.textContent = reagentMmol.toFixed(3);
                eqInput.value = eq.toFixed(2);
                return { eq: eq, mmol: reagentMmol };
            }
            return null;
        }

        // 2. Pure Liquid Calculation (Volume = Mass / Density)
        function calculatePureLiquidVolume(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const mw = parseFloat(reagentRow.querySelector('.reagent-mw').value) || 0;
            const eq = parseFloat(reagentRow.querySelector('.reagent-eq').value) || 0;
            const density = parseFloat(reagentRow.querySelector('.reagent-density').value) || 0;
            const purity = parseFloat(reagentRow.querySelector('.reagent-purity').value) || 100;

            const volumeInput = reagentRow.querySelector('.reagent-volume');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && mw > 0 && eq >= 0 && density > 0 && purity > 0) {
                const targetMmol = smMmol * eq;
                const theoreticalMass = targetMmol * mw; // mg
                const realMass = theoreticalMass / (purity / 100); // mg (scaled)
                const volume = realMass / density / 1000; // mL

                mmolDisplay.textContent = targetMmol.toFixed(3);
                volumeInput.value = volume.toFixed(3); // 3 decimal places for mL

                return { mmol: targetMmol, volume: volume };
            }
            return { mmol: 0, volume: 0 };
        }

        function calculatePureLiquidEquivalents(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const mw = parseFloat(reagentRow.querySelector('.reagent-mw').value) || 0;
            const density = parseFloat(reagentRow.querySelector('.reagent-density').value) || 0;
            const purity = parseFloat(reagentRow.querySelector('.reagent-purity').value) || 100;
            const volume = parseFloat(reagentRow.querySelector('.reagent-volume').value) || 0;
            
            const eqInput = reagentRow.querySelector('.reagent-eq');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && mw > 0 && density > 0 && volume > 0) {
                const realMass = volume * density * 1000; // mg
                const theoreticalMass = realMass * (purity / 100);
                const reagentMmol = theoreticalMass / mw;
                const eq = reagentMmol / smMmol;

                mmolDisplay.textContent = reagentMmol.toFixed(3);
                eqInput.value = eq.toFixed(2);
                return { eq: eq, mmol: reagentMmol };
            }
            return null;
        }

        // 3. Solution (Molarity) Calculation
        function calculateMolarityVolume(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const eq = parseFloat(reagentRow.querySelector('.reagent-eq').value) || 0;
            const molarity = parseFloat(reagentRow.querySelector('.reagent-molarity').value) || 0;
            const volumeInput = reagentRow.querySelector('.reagent-volume');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && molarity > 0 && eq >= 0) {
                const reagentMmol = smMmol * eq;
                const volume = reagentMmol / molarity; // mL

                mmolDisplay.textContent = reagentMmol.toFixed(3);
                volumeInput.value = volume.toFixed(3); // 3 decimal places
                return { mmol: reagentMmol, volume: volume };
            }
            return { mmol: 0, volume: 0 };
        }

        function calculateMolarityEquivalents(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const molarity = parseFloat(reagentRow.querySelector('.reagent-molarity').value) || 0;
            const volume = parseFloat(reagentRow.querySelector('.reagent-volume').value) || 0;
            const eqInput = reagentRow.querySelector('.reagent-eq');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && molarity > 0 && volume > 0) {
                const reagentMmol = molarity * volume;
                const eq = reagentMmol / smMmol;

                mmolDisplay.textContent = reagentMmol.toFixed(3);
                eqInput.value = eq.toFixed(2);
                return { eq: eq, mmol: reagentMmol };
            }
            return null;
        }

        // 4. Solution (Wt%/Density) Calculation - reusing Pure Liquid Logic logic but separating for clarity
        function calculateDensityVolume(reagentRow) {
            // Logic is identical to Pure Liquid: Mass -> Vol via Density, Purity applies to solute
            return calculatePureLiquidVolume(reagentRow);
        }

        function calculateDensityEquivalents(reagentRow) {
            return calculatePureLiquidEquivalents(reagentRow);
        }
        // Recalculate all reagent rows
        function recalculateAllReagents() {
            const reagentRows = document.querySelectorAll('.reagent-row');
            reagentRows.forEach(row => {
                const massInput = row.querySelector('.reagent-mass');
                const volumeInput = row.querySelector('.reagent-volume');

                // Only recalculate if not manually overridden
                if (!massInput.dataset.manualOverride && !volumeInput.dataset.manualOverride) {
                    calculateReagent(row, 'forward');
                }
            });
        }

        // ===== v3.0: Limiting Reagent Logic =====

        /**
         * Determine the limiting reagent based on mmol values
         * Compares SM and all reagents with role=reactant
         */
        function determineLimitingReagent() {
            const reactants = [];

            // SM is always a reactant
            const smMmol = reactionPlan.startingMaterial.mmol;
            if (smMmol > 0) {
                reactants.push({
                    id: "sm",
                    mmol: smMmol,
                    stoichCoeff: 1,
                    effectiveMmol: smMmol
                });
            }

            // Filter reagents with role=reactant or reagent (not catalyst)
            reactionPlan.reagents
                .filter(r => ['reactant', 'reagent'].includes(r.role) && r.mmol > 0)
                .forEach(r => {
                    const stoichCoeff = r.stoichCoeff || 1;
                    reactants.push({
                        id: r.id,
                        mmol: r.mmol,
                        stoichCoeff: stoichCoeff,
                        effectiveMmol: r.mmol / stoichCoeff
                    });
                });

            // Find the one with minimum effectiveMmol
            if (reactants.length === 0) {
                reactionPlan.limitingReagent = null;
                updateLimitingReagentUI(null);
                calculateTheoreticalYield(0);
                return null;
            }

            const limiting = reactants.reduce((min, curr) =>
                curr.effectiveMmol < min.effectiveMmol ? curr : min
            );

            reactionPlan.limitingReagent = limiting.id;

            // Update UI
            updateLimitingReagentUI(limiting.id);

            // Calculate theoretical yield based on limiting reagent
            calculateTheoreticalYield(limiting.effectiveMmol);

            return limiting.id;
        }

        /**
         * Update UI to show limiting reagent badge
         */
        function updateLimitingReagentUI(limitingId) {
            // Clear all existing badges
            document.querySelectorAll(".limiting-badge").forEach(el => el.remove());
            document.querySelectorAll(".compound-card").forEach(el => {
                el.classList.remove("is-limiting");
            });

            if (!limitingId) return;

            // Find the target card
            let targetCard;
            if (limitingId === "sm") {
                targetCard = document.getElementById("sm-card");
            } else {
                targetCard = document.querySelector(`[data-reagent-id="${limitingId}"]`);
            }

            if (targetCard) {
                targetCard.classList.add("is-limiting");
                const header = targetCard.querySelector(".card-header");

                // Create badge
                const badge = document.createElement("span");
                badge.className = "limiting-badge";
                badge.textContent = "üèÜ Limiting";

                // Insert before remove button if exists, otherwise append
                const removeBtn = header.querySelector(".remove-btn");
                if (removeBtn) {
                    header.insertBefore(badge, removeBtn);
                } else {
                    header.appendChild(badge);
                }
            }
        }

        /**
         * Calculate theoretical yield based on limiting reagent mmol
         */
        function calculateTheoreticalYield(limitingMmol) {
            const productMW = parseFloat(document.getElementById("product-mw").value) || 0;

            if (limitingMmol > 0 && productMW > 0) {
                // Theoretical yield (mg) = mmol * MW
                const theoreticalYield = limitingMmol * productMW;
                reactionPlan.product.theoreticalYield = theoreticalYield;
                document.getElementById("product-theoretical").textContent = theoreticalYield.toFixed(2);

                // Recalculate percent yield
                calculatePercentYield();
            } else {
                reactionPlan.product.theoreticalYield = 0;
                document.getElementById("product-theoretical").textContent = "-";
                calculatePercentYield();
            }
        }

        /**
         * Calculate percent yield and update traffic light display
         */
        function calculatePercentYield() {
            const actualMass = parseFloat(document.getElementById("product-actual").value) || 0;
            const theoreticalYield = reactionPlan.product.theoreticalYield;

            const yieldBar = document.getElementById("yield-bar");
            const yieldPercentage = document.getElementById("yield-percentage");
            const yieldDisplay = document.getElementById("yield-display");

            if (actualMass > 0 && theoreticalYield > 0) {
                const percentYield = (actualMass / theoreticalYield) * 100;
                reactionPlan.product.percentYield = percentYield;
                reactionPlan.product.actualMass = actualMass;

                // Update UI
                yieldPercentage.textContent = percentYield.toFixed(1) + "%";
                yieldBar.style.width = Math.min(percentYield, 100) + "%";

                // Traffic light logic
                yieldDisplay.classList.remove("yield-excellent", "yield-good", "yield-poor");
                if (percentYield >= 80) {
                    yieldDisplay.classList.add("yield-excellent");  // Green
                } else if (percentYield >= 50) {
                    yieldDisplay.classList.add("yield-good");       // Yellow
                } else {
                    yieldDisplay.classList.add("yield-poor");       // Red
                }
            } else {
                reactionPlan.product.percentYield = 0;
                yieldPercentage.textContent = "--%";
                yieldBar.style.width = "0%";
                yieldDisplay.classList.remove("yield-excellent", "yield-good", "yield-poor");
            }
        }


        // Handle reagent type change
        function handleTypeChange(reagentId, row) {
            const typeSelect = row.querySelector('.reagent-type');
            const type = typeSelect.value;

            // Update data attribute for CSS
            row.dataset.type = type;

            // Clear manual override flags
            row.querySelector('.reagent-mass').dataset.manualOverride = '';
            row.querySelector('.reagent-volume').dataset.manualOverride = '';

            // IMPORTANT: Clear ALL type-specific fields unconditionally when switching
            // This prevents data residue from previous type selections
            row.querySelector('.reagent-mass').value = '';
            row.querySelector('.reagent-volume').value = '';
            row.querySelector('.reagent-molarity').value = '';
            row.querySelector('.reagent-density').value = '';
            row.querySelector('.reagent-purity').value = '';

            // Recalculate with new type
            calculateReagent(row, 'forward');
            updateReagentInModel(reagentId, row);
        }

        // ===== PubChem API Integration Module =====

        /**
         * Fetch compound data from PubChem by CAS number
         * @param {string} cas - CAS registry number (e.g., "50-78-2")
         * @returns {Promise<Object>} - Compound data {mw, name, smiles}
         */
        async function fetchPubChemData(cas) {
            if (!cas || cas.trim() === '') {
                throw new Error('CAS number is required');
            }

            const cleanCas = cas.trim();

            // Construct API URL - explicitly include all SMILES properties
            const apiUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(cleanCas)}/property/MolecularWeight,IUPACName,CanonicalSMILES,IsomericSMILES/JSON`;

            console.log('=== PubChem Fetch Debug ===');
            console.log('CAS Number:', cleanCas);
            console.log('Final Request URL:', apiUrl);

            try {
                const response = await fetch(apiUrl);
                console.log('Response Status:', response.status, response.statusText);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('CAS not found in PubChem database');
                    }
                    throw new Error(`PubChem API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Full API Response:', JSON.stringify(data, null, 2));

                if (!data.PropertyTable || !data.PropertyTable.Properties || data.PropertyTable.Properties.length === 0) {
                    throw new Error('No compound data found');
                }

                const compound = data.PropertyTable.Properties[0];
                console.log('Compound Object Keys:', Object.keys(compound));
                console.log('Compound data extracted:', compound);

                // Try multiple ways to extract SMILES
                let smiles = '';

                // Method 1: Direct property access
                if (compound.IsomericSMILES) {
                    smiles = compound.IsomericSMILES;
                    console.log('SMILES found via IsomericSMILES property:', smiles);
                } else if (compound.CanonicalSMILES) {
                    smiles = compound.CanonicalSMILES;
                    console.log('SMILES found via CanonicalSMILES property:', smiles);
                } else if (compound.SMILES) {
    smiles = compound.SMILES;
} else {
                    console.error('SMILES not found in compound properties');
                    console.error('Available properties:', Object.keys(compound));
                }

                const result = {
                    mw: parseFloat(compound.MolecularWeight) || 0,
                    name: compound.IUPACName || '',
                    smiles: smiles
                };

                console.log('Final parsed result:', result);
                console.log('=== End Debug ===');
                return result;
            } catch (error) {
                console.error('PubChem fetch error:', error);
                throw error;
            }
        }


        // ===== v3.0: GHS Safety Information =====

        const GHS_EMOJI_MAP = {
            'H220': 'üî•', 'H221': 'üî•', 'H222': 'üî•', 'H223': 'üî•', 'H224': 'üî•', 
            'H225': 'üî•', 'H226': 'üî•', 'H227': 'üî•', 'H228': 'üî•',
            'H200': 'üí•', 'H201': 'üí•', 'H202': 'üí•', 'H203': 'üí•', 'H240': 'üí•', 'H241': 'üí•',
            'H270': '‚ö°', 'H271': '‚ö°', 'H272': '‚ö°',
            'H300': '‚ò†Ô∏è', 'H301': '‚ò†Ô∏è', 'H310': '‚ò†Ô∏è', 'H311': '‚ò†Ô∏è', 'H330': '‚ò†Ô∏è', 'H331': '‚ò†Ô∏è',
            'H302': '‚ö†Ô∏è', 'H312': '‚ö†Ô∏è', 'H332': '‚ö†Ô∏è',
            'H314': 'üß™', 'H318': 'üß™',
            'H315': '‚ö†Ô∏è', 'H319': '‚ö†Ô∏è', 'H335': '‚ö†Ô∏è',
            'H317': '‚ö†Ô∏è', 'H334': 'ü´Å',
            'H340': 'üß¨', 'H341': 'üß¨', 'H350': 'üß¨', 'H351': 'üß¨', 
            'H360': 'üß¨', 'H361': 'üß¨', 'H362': 'üß¨',
            'H370': 'üíÄ', 'H371': '‚ö†Ô∏è', 'H372': 'üíÄ', 'H373': '‚ö†Ô∏è',
            'H400': 'üêü', 'H401': 'üêü', 'H402': 'üêü', 'H410': 'üêü', 
            'H411': 'üêü', 'H412': 'üêü', 'H413': 'üêü'
        };

        async function fetchGHSData(cas) {
            try {
                const cidUrl = 'https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/' + encodeURIComponent(cas) + '/cids/JSON';
                const cidResponse = await fetch(cidUrl);

                if (!cidResponse.ok) {
                    console.warn('[GHS] CID lookup failed for CAS:', cas);
                    return { hCodes: [], pictograms: [] };
                }

                const cidData = await cidResponse.json();
                const cid = cidData.IdentifierList && cidData.IdentifierList.CID && cidData.IdentifierList.CID[0];

                if (!cid) {
                    console.warn('[GHS] No CID found for CAS:', cas);
                    return { hCodes: [], pictograms: [] };
                }

                const ghsUrl = 'https://pubchem.ncbi.nlm.nih.gov/rest/pug_view/data/compound/' + cid + '/JSON?heading=GHS+Classification';
                const ghsResponse = await fetch(ghsUrl);

                if (!ghsResponse.ok) {
                    console.warn('[GHS] GHS data not available for CID:', cid);
                    return { hCodes: [], pictograms: [] };
                }

                const ghsData = await ghsResponse.json();
                return parseGHSResponse(ghsData);

            } catch (error) {
                console.error('[GHS] Error fetching GHS data:', error);
                return { hCodes: [], pictograms: [] };
            }
        }

        function parseGHSResponse(ghsData) {
            const hCodes = new Set();
            const pictograms = new Set();

            try {
                function searchForHazardStatements(obj) {
                    if (!obj) return;

                    if (Array.isArray(obj)) {
                        obj.forEach(function(item) { searchForHazardStatements(item); });
                        return;
                    }

                    if (typeof obj === 'object') {
                        if (obj.String && typeof obj.String === 'string') {
                            const match = obj.String.match(/^(H[0-9]{3}[A-Za-z]?):/);
                            if (match) {
                                const hCode = match[1].toUpperCase();
                                hCodes.add(hCode);
                                if (GHS_EMOJI_MAP[hCode]) {
                                    pictograms.add(GHS_EMOJI_MAP[hCode]);
                                }
                            }
                        }

                        if (obj.StringWithMarkup && Array.isArray(obj.StringWithMarkup)) {
                            obj.StringWithMarkup.forEach(function(item) {
                                if (item.String) {
                                    const match = item.String.match(/^(H[0-9]{3}[A-Za-z]?):/);
                                    if (match) {
                                        const hCode = match[1].toUpperCase();
                                        hCodes.add(hCode);
                                        if (GHS_EMOJI_MAP[hCode]) {
                                            pictograms.add(GHS_EMOJI_MAP[hCode]);
                                        }
                                    }
                                }
                            });
                        }

                        Object.values(obj).forEach(function(val) { searchForHazardStatements(val); });
                    }
                }

                searchForHazardStatements(ghsData);

            } catch (error) {
                console.error('[GHS] Error parsing GHS response:', error);
            }

            return {
                hCodes: Array.from(hCodes).sort(),
                pictograms: Array.from(pictograms)
            };
        }

        function displayGHSPictograms(cardOrId, ghsData) {
            const card = typeof cardOrId === 'string'
                ? document.getElementById(cardOrId)
                : cardOrId;

            if (!card) return;

            const existing = card.querySelector('.ghs-icons');
            if (existing) existing.remove();

            if (!ghsData.pictograms || ghsData.pictograms.length === 0) return;

            const ghsContainer = document.createElement('div');
            ghsContainer.className = 'ghs-icons';

            const uniquePictograms = Array.from(new Set(ghsData.pictograms)).slice(0, 3);
            const tooltip = document.createElement('span');
            tooltip.className = 'ghs-tooltip';
            tooltip.textContent = ghsData.hCodes.join(', ');
            
            ghsContainer.textContent = uniquePictograms.join('');
            ghsContainer.appendChild(tooltip);

            const header = card.querySelector('.card-header');
            if (header) {
                header.appendChild(ghsContainer);
            }
        }


        /**
         * Populate Starting Material fields with PubChem data
         * @param {Object} data - {mw, name, smiles}
         */
        function populateStartingMaterialFromPubChem(data) {
            console.log('[SM Populate] Starting with data:', data);

            // Fill MW (ensure it's a number before calling toFixed)
            const mwValue = parseFloat(data.mw) || 0;
            document.getElementById('sm-mw').value = mwValue.toFixed(2);
            console.log('[SM Populate] MW set to:', mwValue.toFixed(2));

            // Fill SMILES - with validation and fallback
            const smilesInput = document.getElementById('sm-smiles');
            if (data.smiles && data.smiles.trim() !== '') {
                smilesInput.value = data.smiles.trim();
                console.log('[SM Populate] SMILES set to:', data.smiles.trim());
            } else {
                smilesInput.value = '';
                console.error('[SM Populate] SMILES not found or empty in API data');
                alert('Warning: SMILES data not available from PubChem for this compound');
            }

            // Update data model
            updateStartingMaterialData();

            // Auto-draw structure - force immediate drawing
            const smilesValue = smilesInput.value;
            if (smilesValue && smilesValue.trim() !== '') {
                console.log('[SM Populate] Drawing structure with SMILES:', smilesValue);
                drawStructure(smilesValue, 'sm-canvas', 'sm-error');
            } else {
                console.warn('[SM Populate] Skipping structure drawing - no valid SMILES');
            }

            // Recalculate if mass is already entered
            if (document.getElementById('sm-mass').value) {
                calculateSMMmol();
            }

            console.log('[SM Populate] Population complete');
        }

        /**
         * Populate Product fields with PubChem data
         * @param {Object} data - {mw, name, smiles}
         */
        function populateProductFromPubChem(data) {
            console.log('[Product Populate] Starting with data:', data);

            // Fill SMILES - with validation
            const smilesInput = document.getElementById('product-smiles');
            if (data.smiles && data.smiles.trim() !== '') {
                smilesInput.value = data.smiles.trim();
                console.log('[Product Populate] SMILES set to:', data.smiles.trim());
            } else {
                smilesInput.value = '';
                console.error('[Product Populate] SMILES not found or empty in API data');
                alert('Warning: SMILES data not available from PubChem for this compound');
            }

            // Update data model
            reactionPlan.product.smiles = smilesInput.value;
            reactionPlan.product.mw = parseFloat(data.mw) || 0;
            reactionPlan.product.name = data.name || '';

            // Auto-draw structure
            const smilesValue = smilesInput.value;
            if (smilesValue && smilesValue.trim() !== '') {
                console.log('[Product Populate] Drawing structure with SMILES:', smilesValue);
                drawStructure(smilesValue, 'product-canvas', 'product-error');
            }

            console.log('[Product Populate] Population complete');
        }

        /**
         * Populate Reagent fields with PubChem data
         * @param {Object} data - {mw, name, smiles}
         * @param {HTMLElement} row - Reagent row element
         * @param {string} reagentId - Reagent ID (e.g., 'r1')
         */
        function populateReagentFromPubChem(data, row, reagentId) {
            console.log(`[Reagent ${reagentId} Populate] Starting with data:`, data);

            // Fill Name (IUPAC) - with validation
            const nameInput = row.querySelector('.reagent-name');
            if (data.name && data.name.trim() !== '') {
                nameInput.value = data.name.trim();
                console.log(`[Reagent ${reagentId} Populate] Name set to:`, data.name.trim());
            } else {
                nameInput.value = 'Unknown compound';
                console.warn(`[Reagent ${reagentId} Populate] Name not found, using default`);
            }

            // Fill MW (ensure it's a number before calling toFixed)
            const mwInput = row.querySelector('.reagent-mw');
            const mwValue = parseFloat(data.mw) || 0;
            mwInput.value = mwValue.toFixed(2);
            console.log(`[Reagent ${reagentId} Populate] MW set to:`, mwValue.toFixed(2));

            // Validate SMILES data (for logging purposes)
            if (!data.smiles || data.smiles.trim() === '') {
                console.warn(`[Reagent ${reagentId} Populate] SMILES not available from PubChem`);
            } else {
                console.log(`[Reagent ${reagentId} Populate] SMILES available:`, data.smiles);
            }

            // Update data model
            updateReagentInModel(reagentId, row);

            // Trigger calculation (if SM data exists)
            if (reactionPlan.startingMaterial.mmol > 0) {
                const massInput = row.querySelector('.reagent-mass');
                const volumeInput = row.querySelector('.reagent-volume');
                massInput.dataset.manualOverride = '';
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
            }

            console.log(`[Reagent ${reagentId} Populate] Population complete`);
        }

        /**
         * Handle SM Fetch button click
         */
        async function handleSMFetch() {
            const casInput = document.getElementById('sm-cas');
            const fetchBtn = document.getElementById('sm-fetch-btn');
            const cas = casInput.value.trim();

            console.log('[SM Fetch] Starting fetch for CAS:', cas);

            if (!cas) {
                showToast('‚ö†Ô∏è Please enter a CAS number', 'warning');
                return;
            }

            // Set loading state
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'Loading...';
            fetchBtn.classList.add('loading');

            try {
                console.log('[SM Fetch] Calling fetchPubChemData...');
                const data = await fetchPubChemData(cas);
                console.log('[SM Fetch] Data received:', data);

                console.log('[SM Fetch] Calling populateStartingMaterialFromPubChem...');
                populateStartingMaterialFromPubChem(data);
                
                // v3.0: Fetch GHS data
                const ghsData = await fetchGHSData(cas);
                displayGHSPictograms('sm-card', ghsData);
                reactionPlan.startingMaterial.ghsData = ghsData;
                
                saveToLocalStorage();

                // Success feedback
                fetchBtn.textContent = 'Fetched!';
                console.log('[SM Fetch] Fetch successful!');
                setTimeout(() => {
                    fetchBtn.textContent = 'Fetch';
                }, 1500);
            } catch (error) {
                console.error('[SM Fetch] Error occurred:', error);
                alert(`Error: ${error.message}`);
                // Reset button text immediately on error
                fetchBtn.textContent = 'Fetch';
            } finally {
                // ALWAYS reset button state (success or failure)
                fetchBtn.disabled = false;
                fetchBtn.classList.remove('loading');
            }
        }

        /**
         * Handle Product Fetch button click
         */
        async function handleProductFetch() {
            const casInput = document.getElementById('product-cas');
            const fetchBtn = document.getElementById('product-fetch-btn');
            const cas = casInput.value.trim();

            console.log('[Product Fetch] Starting fetch for CAS:', cas);

            if (!cas) {
                showToast('‚ö†Ô∏è Please enter a CAS number', 'warning');
                return;
            }

            // Set loading state
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'Loading...';
            fetchBtn.classList.add('loading');

            try {
                console.log('[Product Fetch] Calling fetchPubChemData...');
                const data = await fetchPubChemData(cas);
                console.log('[Product Fetch] Data received:', data);

                console.log('[Product Fetch] Calling populateProductFromPubChem...');
                populateProductFromPubChem(data);

                // Update CAS in data model
                reactionPlan.product.cas = cas;
                saveToLocalStorage();

                // Success feedback
                fetchBtn.textContent = 'Fetched!';
                console.log('[Product Fetch] Fetch successful!');
                setTimeout(() => {
                    fetchBtn.textContent = 'Fetch';
                }, 1500);
            } catch (error) {
                console.error('[Product Fetch] Error occurred:', error);
                alert(`Error: ${error.message}`);
                // Reset button text immediately on error
                fetchBtn.textContent = 'Fetch';
            } finally {
                // ALWAYS reset button state (success or failure)
                fetchBtn.disabled = false;
                fetchBtn.classList.remove('loading');
            }
        }

        /**
         * Handle Solvent CAS Fetch button click
         * Fetches solvent name from PubChem, and tries to get boiling point
         */
        async function handleSolventFetch() {
            const casInput = document.getElementById('solvent-cas');
            const fetchBtn = document.getElementById('solvent-fetch-btn');
            const nameInput = document.getElementById('solvent-name');
            const bpInput = document.getElementById('solvent-bp');
            const cas = casInput.value.trim();

            console.log('[Solvent Fetch] Starting fetch for CAS:', cas);

            if (!cas) {
                showToast('‚ö†Ô∏è Please enter a CAS number', 'warning');
                return;
            }

            // Set loading state
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'Loading...';
            fetchBtn.classList.add('loading');

            try {
                // Step 1: Get basic compound info (name) from PubChem
                const basicUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(cas)}/property/IUPACName,Title/JSON`;
                console.log('[Solvent Fetch] Fetching basic info:', basicUrl);

                const basicResponse = await fetch(basicUrl);
                if (!basicResponse.ok) {
                    if (basicResponse.status === 404) {
                        throw new Error('CAS not found in PubChem database');
                    }
                    throw new Error(`PubChem API error: ${basicResponse.status}`);
                }

                const basicData = await basicResponse.json();
                const compound = basicData.PropertyTable?.Properties?.[0];

                if (!compound) {
                    throw new Error('No compound data found');
                }

                // Fill solvent name (prefer Title over IUPACName for common name)
                const solventName = compound.Title || compound.IUPACName || '';
                nameInput.value = solventName;
                console.log('[Solvent Fetch] Name set to:', solventName);

                // Step 2: Try to get boiling point from PUG View API
                try {
                    const cid = compound.CID || basicData.PropertyTable?.Properties?.[0]?.CID;
                    if (cid) {
                        // Need to get CID first if not available
                        const cidUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(cas)}/cids/JSON`;
                        const cidResponse = await fetch(cidUrl);
                        const cidData = await cidResponse.json();
                        const compoundCid = cidData.IdentifierList?.CID?.[0];

                        if (compoundCid) {
                            const bpUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug_view/data/compound/${compoundCid}/JSON?heading=Boiling+Point`;
                            console.log('[Solvent Fetch] Fetching boiling point:', bpUrl);

                            const bpResponse = await fetch(bpUrl);
                            if (bpResponse.ok) {
                                const bpData = await bpResponse.json();
                                // Navigate the nested structure to find boiling point value
                                const sections = bpData.Record?.Section || [];
                                let boilingPoint = '';

                                for (const section of sections) {
                                    if (section.TOCHeading === 'Chemical and Physical Properties') {
                                        const subSections = section.Section || [];
                                        for (const subSection of subSections) {
                                            if (subSection.TOCHeading === 'Experimental Properties') {
                                                const props = subSection.Section || [];
                                                for (const prop of props) {
                                                    if (prop.TOCHeading === 'Boiling Point') {
                                                        const info = prop.Information?.[0];
                                                        if (info?.Value?.StringWithMarkup?.[0]?.String) {
                                                            boilingPoint = info.Value.StringWithMarkup[0].String;
                                                            break;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                if (boilingPoint) {
                                    bpInput.value = boilingPoint;
                                    console.log('[Solvent Fetch] BP set to:', boilingPoint);
                                }
                            }
                        }
                    }
                } catch (bpError) {
                    console.log('[Solvent Fetch] Could not fetch boiling point:', bpError.message);
                    // Don't throw - just leave BP empty
                }

                // Update data model and save
                updateConditionsData();
                saveToLocalStorage();

                // Success feedback
                fetchBtn.textContent = 'Fetched!';
                console.log('[Solvent Fetch] Fetch successful!');
                setTimeout(() => {
                    fetchBtn.textContent = 'Fetch';
                }, 1500);
            } catch (error) {
                console.error('[Solvent Fetch] Error occurred:', error);
                alert(`Error: ${error.message}`);
                fetchBtn.textContent = 'Fetch';
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.classList.remove('loading');
            }
        }

        /**
         * Handle Reagent Fetch button click
         * @param {string} reagentId - Reagent ID (e.g., 'r1')
         */
        async function handleReagentFetch(row) {
            // 1. ËÆäÊï∏ÂÆöÁæ©Âú®ÊúÄ‰∏äÈù¢ÔºåÁ¢∫‰øùÁµÇÊñºÂçÄÂ°ä(finally)‰∏ÄÂÆöÊäìÂæóÂà∞ÊåâÈàï
            const fetchBtn = row.querySelector('.reagent-fetch-btn');
            const casInput = row.querySelector('.reagent-cas');
            const nameInput = row.querySelector('.reagent-name');
            const mwInput = row.querySelector('.reagent-mw');
            
            // ÂèñÂæóËº∏ÂÖ•ÁöÑ CAS
            const cas = casInput.value.trim();

            if (!cas) {
                showToast('‚ö†Ô∏è Please enter a CAS number', 'warning');
                return;
            }

            try {
                // 2. ÈéñÂÆöÊåâÈàïÔºåËÆäÊõ¥ÊñáÂ≠óÁÇ∫ Loading...
                fetchBtn.disabled = true;
                fetchBtn.textContent = 'Loading...';
                fetchBtn.classList.add('loading');

                // 3. ÂëºÂè´ PubChem API (ÂåÖÂê´ SMILES)
                const response = await fetch(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${cas}/property/MolecularWeight,IUPACName,CanonicalSMILES,IsomericSMILES/JSON`);

                if (!response.ok) {
                    throw new Error('CAS not found in PubChem database');
                }

                const data = await response.json();

                if (data.PropertyTable && data.PropertyTable.Properties.length > 0) {
                    const props = data.PropertyTable.Properties[0];

                    // Â°´ÂÖ•Êï∏Êìö
                    mwInput.value = props.MolecularWeight;
                    nameInput.value = props.IUPACName;

                    // Ëß∏ÁôºÈáçÊñ∞Ë®àÁÆó
                    calculateReagent(row, 'forward');
                    updateReagentInModel(row.dataset.reagentId, row);

                    // Áç≤Âèñ SMILES ‰∏¶Áπ™Ë£ΩÁµêÊßã
                    const smiles = props.IsomericSMILES || props.CanonicalSMILES || '';
                    if (smiles) {
                        const canvas = row.querySelector('.reagent-canvas');
                        if (canvas) {
                            drawReagentStructure(smiles, canvas);
                            // ‰øùÂ≠ò SMILES Âà∞ row ÁöÑ data Â±¨ÊÄß
                            row.dataset.smiles = smiles;
                        }
                    }
                    
                    // v3.0: Fetch GHS data
                    const ghsData = await fetchGHSData(cas);
                    displayGHSPictograms(row, ghsData);
                    
                    // Store GHS data in model
                    const reagentId = row.dataset.reagentId;
                    const reagent = reactionPlan.reagents.find(function(r) { return r.id === reagentId; });
                    if (reagent) {
                        reagent.ghsData = ghsData;
                    }

                    saveToLocalStorage();
                } else {
                    throw new Error('No data found for this CAS');
                }

            } catch (error) {
                console.error('Fetch error:', error);
                // ÈÄôË£°ÊúÉË∑≥Âá∫ AlertÔºåÊ∏¨Ë©¶ËÖ≥Êú¨ÊúÉÊäìÂà∞ÈÄôÂÄã
                alert(error.message);
            } finally {
                // 4. „ÄêÈóúÈçµ‰øÆÂæ©„ÄëÁÑ°Ë´ñÊàêÂäüÈÇÑÊòØÂ§±ÊïóÔºåÈÄôË£°‰∏ÄÂÆöÊúÉÂü∑Ë°åÔºÅ
                // Âº∑Âà∂ÊääÊåâÈàïËÆäÂõûÂéüÁãÄ
                if (fetchBtn) {
                    fetchBtn.disabled = false;
                    fetchBtn.textContent = 'Fetch';
                    fetchBtn.classList.remove('loading');
                }
            }
        }

        // ===== Dynamic Reagent Table Module =====

        // Add new reagent row
        function addReagentRow(reagentName = '', mw = '', eq = '1.0') {
            reagentCounter++;
            const reagentId = `r${reagentCounter}`;
            const container = document.getElementById('reagent-cards');

            const row = document.createElement('div');
            row.className = 'compound-card reagent-card reagent-row';
            row.dataset.reagentId = reagentId;
            row.dataset.type = 'pure-solid';  // Default type

            row.innerHTML = `
                <div class="card-header">
                    <input type="text" class="reagent-name" placeholder="Reagent name" value="${reagentName}">
                    <button class="remove-btn" onclick="removeReagentRow('${reagentId}')" aria-label="Remove reagent">‚úï</button>
                </div>
                <canvas id="canvas-${reagentId}" class="reagent-canvas compound-canvas" width="450" height="300" data-reagent-id="${reagentId}" role="img" aria-label="Reagent molecular structure"></canvas>
                <div class="card-field">
                    <label>CAS No.</label>
                    <div class="cas-input-group">
                        <input type="text" class="reagent-cas" placeholder="CAS No.">
                        <button class="reagent-fetch-btn fetch-btn" aria-label="Fetch data from PubChem">Fetch</button>
                    </div>
                </div>
                <div class="card-field">
                    <label>Type</label>
                    <select class="reagent-type">
                        <option value="pure-solid" selected>Pure Solid</option>
                        <option value="pure-liquid">Pure Liquid</option>
                        <option value="solution-molarity">Solution (M)</option>
                        <option value="solution-density">Solution (Wt%)</option>
                    </select>
                </div>
                <div class="card-field">
                    <label>Role</label>
                    <select class="reagent-role">
                        <option value="reactant">Reactant</option>
                        <option value="reagent" selected>Reagent</option>
                        <option value="catalyst">Catalyst</option>
                    </select>
                </div>
                <div class="card-field">
                    <label>MW (g/mol)</label>
                    <input type="number" class="reagent-mw" step="0.01" min="0" placeholder="MW" value="${mw}">
                </div>
                <div class="card-field">
                    <label>Equivalents</label>
                    <input type="number" class="reagent-eq" step="0.1" min="0" placeholder="Eq" value="${eq}">
                </div>
                <div class="card-field">
                    <label>Amount (mmol)</label>
                    <span class="reagent-mmol">-</span>
                </div>
                <div class="card-field reagent-mass-field">
                    <label>Mass (mg)</label>
                    <input type="number" class="reagent-mass" step="0.1" min="0" placeholder="Mass">
                </div>
                <div class="card-field reagent-volume-field">
                    <label>Volume (mL)</label>
                    <input type="number" class="reagent-volume" step="0.01" min="0" placeholder="Volume">
                </div>
                <div class="card-field reagent-molarity-field">
                    <label>Molarity (M)</label>
                    <input type="number" class="reagent-molarity" step="0.01" min="0" placeholder="M">
                </div>
                <div class="card-field reagent-density-field">
                    <label>Density (g/mL)</label>
                    <input type="number" class="reagent-density" step="0.01" min="0" placeholder="Density">
                </div>
                <div class="card-field reagent-purity-field">
                    <label>Purity (%)</label>
                    <input type="number" class="reagent-purity" step="0.1" min="0" max="100" placeholder="%" value="100">
                </div>
            `;

            container.appendChild(row);

            // Add event listeners for calculation
            const typeSelect = row.querySelector('.reagent-type');
            const mwInput = row.querySelector('.reagent-mw');
            const eqInput = row.querySelector('.reagent-eq');
            const massInput = row.querySelector('.reagent-mass');
            const volumeInput = row.querySelector('.reagent-volume');
            const molarityInput = row.querySelector('.reagent-molarity');
            const densityInput = row.querySelector('.reagent-density');
            const purityInput = row.querySelector('.reagent-purity');
            const nameInput = row.querySelector('.reagent-name');
            const casInput = row.querySelector('.reagent-cas');

            // Type dropdown listener
            typeSelect.addEventListener('change', () => {
                handleTypeChange(reagentId, row);
                saveToLocalStorage();
            });

            // v3.0: Role change listener
            const roleSelect = row.querySelector('.reagent-role');
            roleSelect.addEventListener('change', () => {
                updateReagentInModel(reagentId, row);
                determineLimitingReagent();
                saveToLocalStorage();
            });

            // MW or Eq change ‚Üí Calculate (forward)
            mwInput.addEventListener('input', () => {
                massInput.dataset.manualOverride = '';
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                determineLimitingReagent();
                saveToLocalStorage();
            });

            eqInput.addEventListener('input', () => {
                massInput.dataset.manualOverride = '';
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                determineLimitingReagent();
                saveToLocalStorage();
            });

            // Mass change ‚Üí Calculate equivalents (reverse)
            massInput.addEventListener('input', () => {
                if (massInput.value) {
                    massInput.dataset.manualOverride = 'true';
                    calculateReagent(row, 'reverse');
                }
                updateReagentInModel(reagentId, row);
                determineLimitingReagent();
                saveToLocalStorage();
            });

            // Volume change ‚Üí Calculate equivalents (reverse)
            volumeInput.addEventListener('input', () => {
                if (volumeInput.value) {
                    volumeInput.dataset.manualOverride = 'true';
                    calculateReagent(row, 'reverse');
                }
                updateReagentInModel(reagentId, row);
                determineLimitingReagent();
                saveToLocalStorage();
            });

            // Molarity change ‚Üí Calculate volume (forward)
            molarityInput.addEventListener('input', () => {
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                determineLimitingReagent();
                saveToLocalStorage();
            });

            // Density change ‚Üí Calculate volume (forward)
            densityInput.addEventListener('input', () => {
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                determineLimitingReagent();
                saveToLocalStorage();
            });

            // Purity change ‚Üí Calculate volume (forward)
            purityInput.addEventListener('input', () => {
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                determineLimitingReagent();
                saveToLocalStorage();
            });

            nameInput.addEventListener('input', () => {
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // CAS input listener
            casInput.addEventListener('input', () => {
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // Fetch button listener
            const fetchBtn = row.querySelector('.reagent-fetch-btn');
            fetchBtn.addEventListener('click', () => {
                handleReagentFetch(row);
            });

            // Allow Enter key in CAS input
            casInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleReagentFetch(row);
                }
            });

            // Add to data model
            addReagentToModel(reagentId, reagentName, mw, eq);

            // Calculate initial values if we have SM data
            if (reactionPlan.startingMaterial.mmol > 0) {
                calculateReagent(row, 'forward');
            }

            return row;
        }

        // Remove reagent row
        function removeReagentRow(reagentId) {
            const row = document.querySelector(`[data-reagent-id="${reagentId}"]`);
            if (row) {
                row.remove();
                removeReagentFromModel(reagentId);
                saveToLocalStorage();
            }
        }

        // Data model management for reagents
        function addReagentToModel(id, name = '', mw = 0, eq = 1.0, type = 'pure') {
            reactionPlan.reagents.push({
                id: id,
                name: name,
                type: type,
                role: 'reagent',  // v3.0: Default role
                mw: parseFloat(mw) || 0,
                eq: parseFloat(eq) || 1.0,
                mmol: 0,
                mass: 0,
                volume: 0,
                molarity: 0,
                density: 0,
                purity: 0,
                cas: '',
                ghsData: null  // v3.0: GHS safety data
            });
        }

        function removeReagentFromModel(id) {
            const index = reactionPlan.reagents.findIndex(r => r.id === id);
            if (index !== -1) {
                reactionPlan.reagents.splice(index, 1);
            }
        }

        function updateReagentInModel(id, row) {
            const reagent = reactionPlan.reagents.find(r => r.id === id);
            if (reagent) {
                const typeSelect = row.querySelector('.reagent-type');

                // Common fields
                reagent.name = row.querySelector('.reagent-name').value;
                reagent.type = typeSelect ? typeSelect.value : 'pure';
                
                // v3.0: Update role
                const roleSelect = row.querySelector('.reagent-role');
                reagent.role = roleSelect ? roleSelect.value : 'reagent';
                reagent.mw = parseFloat(row.querySelector('.reagent-mw').value) || 0;
                reagent.eq = parseFloat(row.querySelector('.reagent-eq').value) || 0;

                const mmolText = row.querySelector('.reagent-mmol').textContent;
                reagent.mmol = mmolText !== '-' ? parseFloat(mmolText) : 0;

                reagent.cas = row.querySelector('.reagent-cas').value || '';

                // Type-specific fields
                if (reagent.type === 'pure') {
                    reagent.mass = parseFloat(row.querySelector('.reagent-mass').value) || 0;
                    reagent.volume = 0;
                    reagent.molarity = 0;
                    reagent.density = 0;
                    reagent.purity = 0;
                } else if (reagent.type === 'solution-molarity') {
                    reagent.volume = parseFloat(row.querySelector('.reagent-volume').value) || 0;
                    reagent.molarity = parseFloat(row.querySelector('.reagent-molarity').value) || 0;
                    reagent.mass = 0;
                    reagent.density = 0;
                    reagent.purity = 0;
                } else if (reagent.type === 'solution-density') {
                    reagent.volume = parseFloat(row.querySelector('.reagent-volume').value) || 0;
                    reagent.density = parseFloat(row.querySelector('.reagent-density').value) || 0;
                    reagent.purity = parseFloat(row.querySelector('.reagent-purity').value) || 0;
                    reagent.mass = 0;
                    reagent.molarity = 0;
                }
            }
        }

        // ===== Example Data Loader =====

        function loadExampleData() {
            // Load Starting Material
            document.getElementById('sm-smiles').value = 'CC(=O)OC1=CC=CC=C1C(=O)O';
            document.getElementById('sm-mw').value = '180.16';
            document.getElementById('sm-mass').value = '100';

            // Load Product
            document.getElementById('product-smiles').value = 'O=C(O)c1ccccc1O';

            // Load Conditions
            document.getElementById('solvent-name').value = 'THF';
            document.getElementById('solvent-conc').value = '0.1';
            // Volume will auto-calculate
            document.getElementById('temperature').value = 'rt';
            document.getElementById('time').value = '2 h';
            document.getElementById('notes').value = 'Aspirin hydrolysis example - demonstrates base hydrolysis followed by acidification';

            // Update data model
            updateStartingMaterialData();
            updateProductData();
            updateConditionsData();

            // Render structures
            drawStructure(document.getElementById('sm-smiles').value, 'sm-canvas', 'sm-error');
            drawStructure(document.getElementById('product-smiles').value, 'product-canvas', 'product-error');

            // Calculate SM mmol
            calculateSMMmol();

            // Load example reagents
            addReagentRow('NaOH', '40.00', '2.0');
            addReagentRow('HCl', '36.46', '2.0');
        }

        // ===== v3.2: Procedure Checklist Functions =====

        let stepCounter = 0;

        /**
         * Add a new step to the procedure checklist
         * @param {string} text - The step description
         */
        function addStep(text) {
            if (!text || !text.trim()) return;

            const step = {
                id: `step-${Date.now()}-${stepCounter++}`,
                text: text.trim(),
                isDone: false,
                observation: ''
            };

            reactionPlan.conditions.steps.push(step);
            renderProcedure();
            saveToLocalStorage();

            // Clear input
            document.getElementById('new-step-input').value = '';
        }

        /**
         * Toggle step completion status
         * @param {string} id - The step ID
         */
        function toggleStep(id) {
            const step = reactionPlan.conditions.steps.find(s => s.id === id);
            if (step) {
                step.isDone = !step.isDone;
                renderProcedure();
                saveToLocalStorage();
            }
        }

        /**
         * Remove a step from the checklist
         * @param {string} id - The step ID
         */
        function removeStep(id) {
            reactionPlan.conditions.steps = reactionPlan.conditions.steps.filter(s => s.id !== id);
            renderProcedure();
            saveToLocalStorage();
        }

        /**
         * Update observation text for a step
         * @param {string} id - The step ID
         * @param {string} text - The observation text
         */
        function updateObservation(id, text) {
            const step = reactionPlan.conditions.steps.find(s => s.id === id);
            if (step) {
                step.observation = text;
                saveToLocalStorage();
            }
        }

        /**
         * Escape HTML to prevent XSS
         * @param {string} text - Text to escape
         * @returns {string} Escaped HTML
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        /**
         * Render the procedure checklist UI
         */
        function renderProcedure() {
            const list = document.getElementById('procedure-list');
            const steps = reactionPlan.conditions.steps || [];

            // Update progress badge
            const doneCount = steps.filter(s => s.isDone).length;
            document.getElementById('procedure-progress').textContent = `${doneCount}/${steps.length}`;

            // Generate HTML
            if (steps.length === 0) {
                list.innerHTML = '<li class="procedure-empty">No steps added yet. Add your first step above.</li>';
                return;
            }

            list.innerHTML = steps.map(step => `
                <li class="procedure-item" data-step-id="${step.id}">
                    <div class="step-main">
                        <input type="checkbox" class="step-checkbox" ${step.isDone ? 'checked' : ''}>
                        <span class="step-text ${step.isDone ? 'done' : ''}">${escapeHtml(step.text)}</span>
                        <button class="step-delete-btn" title="Delete step">√ó</button>
                    </div>
                    <div class="step-observation">
                        <input type="text" class="observation-input"
                               placeholder="Observation..."
                               value="${escapeHtml(step.observation)}">
                    </div>
                </li>
            `).join('');

            // Bind events
            list.querySelectorAll('.procedure-item').forEach(item => {
                const id = item.dataset.stepId;

                item.querySelector('.step-checkbox').addEventListener('change', () => toggleStep(id));
                item.querySelector('.step-delete-btn').addEventListener('click', () => removeStep(id));
                item.querySelector('.observation-input').addEventListener('input', (e) => {
                    updateObservation(id, e.target.value);
                });
            });
        }

        // ===== v3.1: JSON Export/Import Functions =====

        /**
         * Export current reaction plan to JSON file
         * v3.1: Save experiment data as downloadable JSON
         */
        function exportToJSON() {
            const dataStr = JSON.stringify(reactionPlan, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const today = new Date();
            const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
            const filename = `DrChem_${dateStr}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            console.log('[Export] Saved as:', filename);
        }

        /**
         * Trigger file input for JSON import
         * v3.1: Load experiment data from JSON file
         */
        function importFromJSON() {
            document.getElementById('fileInput').click();
        }

        /**
         * Handle file input change event for JSON import
         * @param {Event} event - The file input change event
         */
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    restoreReactionPlan(data);
                    alert('Experiment loaded successfully!');
                    console.log('[Import] Loaded from:', file.name);
                } catch (error) {
                    alert('Error loading file: Invalid JSON format');
                    console.error('[Import] Error:', error);
                }
            };
            reader.readAsText(file);

            // Clear input to allow re-selecting the same file
            event.target.value = '';
        }

        // ===== Event Handlers & Initialization =====

        function initializeEventListeners() {
            // SMILES inputs with debouncing
            const smSmilesInput = document.getElementById('sm-smiles');
            const productSmilesInput = document.getElementById('product-smiles');

            const debouncedDrawSM = debounce(() => {
                drawStructure(smSmilesInput.value, 'sm-canvas', 'sm-error');
                updateStartingMaterialData();
                saveToLocalStorage();
            }, 500);

            const debouncedDrawProduct = debounce(() => {
                drawStructure(productSmilesInput.value, 'product-canvas', 'product-error');
                updateProductData();
                saveToLocalStorage();
            }, 500);

            smSmilesInput.addEventListener('input', debouncedDrawSM);
            productSmilesInput.addEventListener('input', debouncedDrawProduct);

            // Also trigger on blur for immediate feedback
            smSmilesInput.addEventListener('blur', () => {
                drawStructure(smSmilesInput.value, 'sm-canvas', 'sm-error');
                updateStartingMaterialData();
                saveToLocalStorage();
            });
            productSmilesInput.addEventListener('blur', () => {
                drawStructure(productSmilesInput.value, 'product-canvas', 'product-error');
                updateProductData();
                saveToLocalStorage();
            });

            // Starting material calculations
            document.getElementById('sm-mass').addEventListener('input', () => {
                calculateSMMmol();
                updateStartingMaterialData();
                saveToLocalStorage();
            });

            document.getElementById('sm-mw').addEventListener('input', () => {
                calculateSMMmol();
                updateStartingMaterialData();
                saveToLocalStorage();
            });

            document.getElementById('sm-cas').addEventListener('input', () => {
                updateStartingMaterialData();
                saveToLocalStorage();
            });

            // Starting Material PubChem fetch
            document.getElementById('sm-fetch-btn').addEventListener('click', handleSMFetch);

            // Allow Enter key in CAS input to trigger fetch
            document.getElementById('sm-cas').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSMFetch();
                }
            });

            // Product PubChem fetch
            document.getElementById('product-fetch-btn').addEventListener('click', handleProductFetch);

            // Allow Enter key in Product CAS input to trigger fetch
            document.getElementById('product-cas').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleProductFetch();
                }
            });

            // Product CAS input change listener (for auto-save)
            document.getElementById('product-cas').addEventListener('input', () => {
                reactionPlan.product.cas = document.getElementById('product-cas').value;
                saveToLocalStorage();
            });

            // Clear All button
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);

            // Add reagent button
            document.getElementById('add-reagent').addEventListener('click', () => {
                addReagentRow();
                saveToLocalStorage();
            });

            // Conditions inputs
            document.getElementById('solvent-name').addEventListener('input', () => {
                updateConditionsData();
                saveToLocalStorage();
            });
            document.getElementById('solvent-cas').addEventListener('input', () => {
                updateConditionsData();
                saveToLocalStorage();
            });
            document.getElementById('solvent-fetch-btn').addEventListener('click', handleSolventFetch);
            document.getElementById('solvent-conc').addEventListener('input', () => {
                calculateSolventVolume();
                updateConditionsData();
                saveToLocalStorage();
            });
            document.getElementById('temperature').addEventListener('input', () => {
                updateConditionsData();
                saveToLocalStorage();
            });
            document.getElementById('time').addEventListener('input', () => {
                updateConditionsData();
                saveToLocalStorage();
            });
            // v3.2: Add Step button event
            document.getElementById('add-step-btn').addEventListener('click', () => {
                const input = document.getElementById('new-step-input');
                addStep(input.value);
            });

            // v3.2: Enter key to add step
            document.getElementById('new-step-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addStep(e.target.value);
                }
            });

            // v3.2: Initial render of procedure list
            renderProcedure();

            // v3.0: Product MW change listener
            document.getElementById('product-mw').addEventListener('input', () => {
                reactionPlan.product.mw = parseFloat(document.getElementById('product-mw').value) || 0;
                determineLimitingReagent();
                saveToLocalStorage();
            });

            // v3.0: Product Actual Mass change listener
            document.getElementById('product-actual').addEventListener('input', () => {
                reactionPlan.product.actualMass = parseFloat(document.getElementById('product-actual').value) || 0;
                calculatePercentYield();
                saveToLocalStorage();
            });

            // Export button (Print)
            document.getElementById('exportBtn').addEventListener('click', () => {
                window.print();
            });

            // v3.1: Save JSON button
            document.getElementById('saveBtn').addEventListener('click', exportToJSON);

            // v3.1: Load JSON button
            document.getElementById('loadBtn').addEventListener('click', importFromJSON);

            // v3.1: File input change handler
            document.getElementById('fileInput').addEventListener('change', handleFileImport);
        }

        // DOM Content Loaded - Initialize everything
        
        // ===== v4.3: Toast Notification System =====
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);

            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ===== v4.3: Loading State Helper =====
        function setButtonLoading(btn, isLoading, originalText = 'Fetch') {
            if (isLoading) {
                btn.dataset.originalText = btn.textContent;
                btn.textContent = '‚è≥ Fetching...';
                btn.classList.add('btn-loading');
                btn.disabled = true;
            } else {
                btn.textContent = btn.dataset.originalText || originalText;
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Digital Reaction Planner initializing...');

            // Initialize smiles-drawer
            initializeSmilesDrawer();

            // Set up event listeners
            initializeEventListeners();

            // Try to load saved data first, fallback to example data
            const dataLoaded = loadFromLocalStorage();

            if (!dataLoaded) {
                // Only load example data if no saved data exists
                loadExampleData();
            }

            console.log('Digital Reaction Planner ready!');
        });
    </script>

    <!-- v4.3: Toast Notification Container -->
    <div id="toast-container"></div>
</body>
</html>
