<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Reaction Planner</title>
    <style>
        /* ===== CSS Variables & Reset ===== */
        :root {
            --primary-color: #007bff;
            --text-color: #000000;
            --background: #ffffff;
            --border-color: #ddd;
            --error-color: #dc3545;
            --success-color: #28a745;
            --card-shadow: 0 2px 4px rgba(0,0,0,0.1);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --limiting-reagent-bg: #f0f8ff;
            --table-header-bg: #f8f9fa;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            line-height: 1.6;
        }

        /* ===== Layout ===== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            gap: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        h1 {
            color: #333;
            margin: 0;
            font-size: 28px;
        }

        h2 {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 20px;
            font-weight: 600;
        }

        /* ===== Card & Section Styles ===== */
        .card {
            background: var(--background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        /* ===== Reaction Scheme Section ===== */
        .reaction-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .molecule-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 280px;
        }

        .molecule-container label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .molecule-container input {
            width: 100%;
            margin-bottom: 10px;
        }

        canvas {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            max-width: 100%;
            height: auto;
        }

        canvas.error {
            border-color: var(--error-color);
            border-width: 2px;
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            min-height: 16px;
            margin-top: 4px;
        }

        .arrow-container {
            font-size: 48px;
            color: #333;
            font-weight: bold;
            margin: 0 10px;
        }

        /* ===== Form Elements ===== */
        input[type="text"],
        input[type="number"],
        textarea {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-family);
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        input.error {
            border-color: var(--error-color);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }

        input[type="text"].smiles-input {
            font-family: monospace;
        }

        input[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: var(--font-family);
        }

        button:hover {
            background-color: #0056b3;
        }

        button:active {
            background-color: #004494;
        }

        button.success {
            background-color: var(--success-color);
        }

        button.success:hover {
            background-color: #1e7e34;
        }

        button.remove-btn {
            background-color: var(--error-color);
            padding: 6px 12px;
            font-size: 12px;
        }

        button.remove-btn:hover {
            background-color: #c82333;
        }

        #exportBtn {
            background-color: var(--success-color);
        }

        #exportBtn:hover {
            background-color: #1e7e34;
        }

        /* ===== Table Styles ===== */
        .table-controls {
            margin-bottom: 15px;
        }

        #stoich-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        #stoich-table thead {
            background: var(--table-header-bg);
            font-weight: 600;
        }

        #stoich-table th,
        #stoich-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        #stoich-table th {
            font-size: 14px;
            color: #555;
        }

        #stoich-table td {
            font-size: 14px;
        }

        .limiting-reagent {
            background: var(--limiting-reagent-bg);
            font-weight: 500;
        }

        #stoich-table input[type="text"],
        #stoich-table input[type="number"] {
            width: 100%;
            max-width: 150px;
            padding: 6px 10px;
            font-size: 13px;
        }

        #stoich-table input.reagent-name {
            max-width: 200px;
        }

        .reagent-mmol {
            font-weight: 500;
            color: #333;
        }

        /* ===== Type-specific field visibility (Updated v1.1) ===== */
        
        /* General Input Sizing */
        #stoich-table input[type="number"] {
            min-width: 80px;
        }

        /* 1. Pure Solid: Show Mass, Purity */
        .reagent-row[data-type="pure-solid"] .reagent-mass,
        .reagent-row[data-type="pure-solid"] .reagent-purity { display: inline-block; }
        
        .reagent-row[data-type="pure-solid"] .reagent-volume,
        .reagent-row[data-type="pure-solid"] .reagent-molarity,
        .reagent-row[data-type="pure-solid"] .reagent-density { display: none; }

        /* 2. Pure Liquid: Show Volume, Density, Purity */
        .reagent-row[data-type="pure-liquid"] .reagent-volume,
        .reagent-row[data-type="pure-liquid"] .reagent-density,
        .reagent-row[data-type="pure-liquid"] .reagent-purity { display: inline-block; }
        
        .reagent-row[data-type="pure-liquid"] .reagent-mass,
        .reagent-row[data-type="pure-liquid"] .reagent-molarity { display: none; }

        /* 3. Solution (Molarity): Show Volume, Molarity */
        .reagent-row[data-type="solution-molarity"] .reagent-volume,
        .reagent-row[data-type="solution-molarity"] .reagent-molarity { display: inline-block; }
        
        .reagent-row[data-type="solution-molarity"] .reagent-mass,
        .reagent-row[data-type="solution-molarity"] .reagent-density,
        .reagent-row[data-type="solution-molarity"] .reagent-purity { display: none; }

        /* 4. Solution (Wt%): Show Volume, Density, Purity */
        .reagent-row[data-type="solution-density"] .reagent-volume,
        .reagent-row[data-type="solution-density"] .reagent-density,
        .reagent-row[data-type="solution-density"] .reagent-purity { display: inline-block; }
        
        .reagent-row[data-type="solution-density"] .reagent-mass,
        .reagent-row[data-type="solution-density"] .reagent-molarity { display: none; }

        /* N/A Placeholder Logic */
        .field-na { display: none; color: #aaa; user-select: none; }
        
        /* Pure Solid needs N/A in Molarity/Density col */
        .reagent-row[data-type="pure-solid"] td:nth-child(8) .field-na { display: inline-block; }
        
        /* Solution Molarity needs N/A in Purity col */
        .reagent-row[data-type="solution-molarity"] td:nth-child(9) .field-na { display: inline-block; }

        /* Hide N/A placeholder in Molarity/Density column when molarity input is active */
        .reagent-row[data-type="solution-molarity"] td:nth-child(8) .field-na { display: none; }

        /* Dropdown styling */
        .reagent-type {
            width: 100%;
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-family);
            background-color: white;
            cursor: pointer;
        }

        .reagent-type:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* ===== CAS Input Group & Fetch Button ===== */
        .cas-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .cas-input {
            flex: 1;
            min-width: 100px;
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .cas-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .fetch-btn {
            padding: 6px 12px;
            font-size: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s;
        }

        .fetch-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .fetch-btn:active:not(:disabled) {
            background-color: #004494;
        }

        .fetch-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.65;
        }

        .fetch-btn.loading {
            background-color: #ffc107;
            color: #000;
        }

        /* ===== Conditions Section ===== */
        .conditions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ===== Solvent Calculator Grid ===== */
        .solvent-calculator {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-top: 8px;
        }

        .solvent-field {
            display: flex;
            flex-direction: column;
        }

        .solvent-field label {
            font-weight: 500;
            font-size: 12px;
            margin-bottom: 4px;
            color: #555;
        }

        .solvent-calculator input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .solvent-calculator input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* ===== Responsive Design ===== */
        @media (max-width: 768px) {
            .reaction-display {
                flex-direction: column;
            }

            .arrow-container {
                transform: rotate(90deg);
            }

            h1 {
                font-size: 22px;
            }

            header {
                flex-direction: column;
                gap: 10px;
            }

            #stoich-table {
                font-size: 12px;
            }

            #stoich-table th,
            #stoich-table td {
                padding: 8px;
            }

            /* Stack solvent calculator vertically on mobile */
            .solvent-calculator {
                grid-template-columns: 1fr;
            }
        }

        /* ===== v1.4 新增樣式 ===== */
        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .clear-btn {
            background-color: var(--error-color);
            color: white;
        }

        .clear-btn:hover {
            background-color: #c82333;
        }

        .clear-btn:active {
            background-color: #a71d2a;
        }

        .reagent-canvas {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            max-width: 150px;
            max-height: 100px;
        }

        .reagent-structure-cell {
            text-align: center;
            vertical-align: middle;
        }

        /* ===== Print Media Queries ===== */
        @media print {
            body {
                margin: 0;
                padding: 10px;
                background: white;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            /* Hide interactive elements */
            button,
            .table-controls {
                display: none !important;
            }

            /* Ensure cards print with borders */
            .card {
                page-break-inside: avoid;
                box-shadow: none;
                margin-bottom: 15px;
                border: 1px solid #ccc;
            }

            /* Optimize canvas for print */
            canvas {
                max-width: 300px;
                height: auto;
            }

            /* Optimize table for print */
            #stoich-table {
                font-size: 11px;
            }

            #stoich-table th,
            #stoich-table td {
                padding: 6px;
            }

            /* Hide CAS column (2nd column) in print */
            #stoich-table th:nth-child(2),
            #stoich-table td:nth-child(2) {
                display: none;
            }

            /* Remove last column (Actions) in print */
            #stoich-table th:last-child,
            #stoich-table td:last-child {
                display: none;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 18px;
            }
        }

        /* Structure Visualization v1.3 */
        .warning-box {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        .force-visible { display: block !important; }
        .force-hidden { display: none !important; }

        /* ===== v2.0 Reaction Scheme Card Layout ===== */
        .reaction-scheme-container {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            overflow-x: auto;
            padding: 20px 10px;
            min-height: 400px;
        }

        .compound-card {
            flex: 0 0 220px;
            min-width: 220px;
            max-width: 220px;
            background: var(--background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .compound-card.sm-card {
            background: var(--limiting-reagent-bg);
            border-color: #b8d4e8;
        }

        .compound-card .card-header {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compound-card .card-header input.reagent-name {
            flex: 1;
            font-weight: 600;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 14px;
            padding: 0;
        }

        .compound-card .card-header input.reagent-name:focus {
            outline: none;
            border-bottom: 1px solid var(--primary-color);
        }

        .compound-canvas {
            width: 100%;
            height: 150px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
        }

        .card-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-field label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .card-field input,
        .card-field select {
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            width: 100%;
            box-sizing: border-box;
        }

        .card-field .fixed-value {
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
        }

        .card-field .reagent-mmol {
            padding: 8px 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .reagent-card .remove-btn {
            padding: 4px 8px;
            font-size: 12px;
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-width: auto;
        }

        .reagent-card .remove-btn:hover {
            background: #c82333;
        }

        .scheme-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #666;
            min-width: 40px;
            align-self: center;
        }

        .reagent-cards-container {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 5px;
        }

        .scheme-controls {
            margin-bottom: 15px;
        }

        /* Card-based Type-specific field visibility */
        .reagent-row .reagent-mass-field,
        .reagent-row .reagent-volume-field,
        .reagent-row .reagent-molarity-field,
        .reagent-row .reagent-density-field,
        .reagent-row .reagent-purity-field { display: none; }

        .reagent-row[data-type="pure-solid"] .reagent-mass-field,
        .reagent-row[data-type="pure-solid"] .reagent-purity-field { display: flex; }

        .reagent-row[data-type="pure-liquid"] .reagent-volume-field,
        .reagent-row[data-type="pure-liquid"] .reagent-density-field,
        .reagent-row[data-type="pure-liquid"] .reagent-purity-field { display: flex; }

        .reagent-row[data-type="solution-molarity"] .reagent-volume-field,
        .reagent-row[data-type="solution-molarity"] .reagent-molarity-field { display: flex; }

        .reagent-row[data-type="solution-density"] .reagent-volume-field,
        .reagent-row[data-type="solution-density"] .reagent-density-field,
        .reagent-row[data-type="solution-density"] .reagent-purity-field { display: flex; }

        /* Responsive design for card layout */
        @media (max-width: 768px) {
            .reaction-scheme-container {
                flex-direction: column;
                align-items: center;
            }

            .scheme-arrow {
                transform: rotate(90deg);
            }

            .compound-card {
                flex: 0 0 280px;
                min-width: 280px;
                max-width: 280px;
            }

            .reagent-cards-container {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Print styles for card layout */
        @media print {
            .reaction-scheme-container {
                flex-wrap: wrap;
                justify-content: center;
            }

            .compound-card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
            }

            .reagent-card .remove-btn,
            .scheme-controls,
            .fetch-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Digital Reaction Planner</h1>
            <div class="header-buttons">
                <button id="clearAllBtn" class="clear-btn" aria-label="Clear all data and reset">Clear All</button>
                <button id="exportBtn" aria-label="Print or export reaction plan">Print/Export</button>
            </div>
        </header>

        <!-- v2.0 Reaction Scheme Section (Card Layout) -->
        <section id="reaction-scheme-section" class="card">
            <h2>Reaction Scheme</h2>
            <div class="scheme-controls">
                <button id="add-reagent" aria-label="Add new reagent">+ Add Reagent</button>
            </div>
            <div class="reaction-scheme-container">
                <!-- Starting Material Card -->
                <div class="compound-card sm-card" id="sm-card">
                    <div class="card-header">Starting Material</div>
                    <canvas id="sm-canvas" class="compound-canvas" width="300" height="250" role="img" aria-label="Starting material molecular structure"></canvas>
                    <div class="card-field">
                        <label for="sm-smiles">SMILES</label>
                        <input type="text" id="sm-smiles" class="smiles-input" placeholder="SMILES notation">
                    </div>
                    <span class="error-message" id="sm-error"></span>
                    <div id="sm-stereo-warning" class="warning-box" style="display: none;">
                        ⚠️ Stereochemistry warning
                    </div>
                    <div class="card-field">
                        <label for="sm-cas">CAS No.</label>
                        <div class="cas-input-group">
                            <input type="text" id="sm-cas" placeholder="CAS No." class="cas-input" aria-label="Starting Material CAS Number">
                            <button id="sm-fetch-btn" class="fetch-btn" aria-label="Fetch data from PubChem">Fetch</button>
                        </div>
                    </div>
                    <div class="card-field">
                        <label for="sm-mw">MW (g/mol)</label>
                        <input type="number" id="sm-mw" step="0.01" min="0" placeholder="MW" aria-label="Starting Material Molecular Weight">
                    </div>
                    <div class="card-field">
                        <label>Equivalents</label>
                        <span class="fixed-value">1.00</span>
                    </div>
                    <div class="card-field">
                        <label for="sm-mmol">Amount (mmol)</label>
                        <input type="number" id="sm-mmol" step="0.001" readonly placeholder="Calculated" aria-label="Starting Material Amount in mmol" aria-readonly="true">
                    </div>
                    <div class="card-field">
                        <label for="sm-mass">Mass (mg)</label>
                        <input type="number" id="sm-mass" step="0.1" min="0" placeholder="Mass" aria-label="Starting Material Mass in mg">
                    </div>
                </div>

                <div class="scheme-arrow">+</div>

                <!-- Reagent Cards Container -->
                <div class="reagent-cards-container" id="reagent-cards">
                    <!-- Dynamic reagent cards will be added here -->
                </div>

                <div class="scheme-arrow">→</div>

                <!-- Product Card -->
                <div class="compound-card product-card" id="product-card">
                    <div class="card-header">Product</div>
                    <canvas id="product-canvas" class="compound-canvas" width="300" height="250" role="img" aria-label="Product molecular structure"></canvas>
                    <div class="card-field">
                        <label for="product-smiles">SMILES</label>
                        <input type="text" id="product-smiles" class="smiles-input" placeholder="SMILES notation">
                    </div>
                    <span class="error-message" id="product-error"></span>
                    <div id="product-stereo-warning" class="warning-box" style="display: none;">
                        ⚠️ Stereochemistry warning
                    </div>
                    <div class="card-field">
                        <label for="product-cas">CAS No.</label>
                        <div class="cas-input-group">
                            <input type="text" id="product-cas" placeholder="CAS No." class="cas-input" aria-label="Product CAS Number">
                            <button id="product-fetch-btn" class="fetch-btn" aria-label="Fetch product data from PubChem">Fetch</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Conditions Section -->
        <section id="conditions-section" class="card">
            <h2>Conditions & Notes</h2>
            <div class="conditions-grid">
                <div class="form-group">
                    <label>Solvent Calculator</label>
                    <div class="solvent-calculator">
                        <div class="solvent-field">
                            <label for="solvent-name">Solvent Name</label>
                            <input type="text" id="solvent-name" placeholder="e.g., THF, DCM">
                        </div>
                        <div class="solvent-field">
                            <label for="solvent-conc">Target Conc. (M)</label>
                            <input type="number" id="solvent-conc" step="0.01" min="0" placeholder="0.1">
                        </div>
                        <div class="solvent-field">
                            <label for="solvent-volume">Volume (mL)</label>
                            <input type="number" id="solvent-volume" readonly placeholder="Auto-calculated">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="temperature">Temperature</label>
                    <input type="text" id="temperature" placeholder="e.g., 25°C, rt">
                </div>
                <div class="form-group">
                    <label for="time">Time</label>
                    <input type="text" id="time" placeholder="e.g., 2 h, overnight">
                </div>
            </div>
            <div class="form-group">
                <label for="notes">Additional Notes</label>
                <textarea id="notes" rows="4" placeholder="Enter reaction notes, observations, or special conditions..."></textarea>
            </div>
        </section>
    </div>

    <!-- External Library -->
    <script src="https://unpkg.com/smiles-drawer@1.2.0/dist/smiles-drawer.min.js"></script>

    <script>
        /**
         * Digital Reaction Planner
         * A tool for calculating stoichiometry and planning chemistry reactions
         *
         * Features:
         * - SMILES structure rendering for starting materials and products
         * - Automatic stoichiometry calculations (mass ↔ mmol ↔ equivalents)
         * - Bidirectional calculation support (forward and reverse)
         * - Dynamic reagent table management
         * - Print/export functionality
         */

        // ===== Global State & Configuration =====

        // Central data model - single source of truth for all reaction data
        const reactionPlan = {
            startingMaterial: {
                smiles: '',
                mw: 0,
                mass: 0,
                mmol: 0,
                cas: ''
            },
            product: {
                smiles: '',
                cas: '',
                mw: 0,
                name: ''
            },
            reagents: [],
            conditions: {
                solventName: '',
                solventConc: 0,
                solventVolume: 0,
                temperature: '',
                time: '',
                notes: ''
            }
        };

        let reagentCounter = 0;
        let drawer = null;

        // ===== Utility Functions =====

        // Debounce function to prevent excessive re-renders
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ===== SMILES Rendering Module =====

        // Initialize SmilesDrawer with academic configuration
        function initializeSmilesDrawer() {
            drawer = new SmilesDrawer.Drawer({
                width: 600,
                height: 500,
                bondThickness: 1.5,
                bondLength: 25,
                shortBondLength: 0.8,
                bondSpacing: 4,
                atomVisualization: 'default',
                isomeric: true,
                debug: false,
                terminalCarbons: true,
                explicitHydrogens: false,
                overlapSensitivity: 0.42,
                overlapResolutionIterations: 1,
                compactDrawing: true,
                fontSizeLarge: 11,
                fontSizeSmall: 6,
                padding: 20,
                themes: {
                    dark: {
                        C: '#000000',
                        O: '#000000',
                        N: '#000000',
                        F: '#000000',
                        CL: '#000000',
                        BR: '#000000',
                        I: '#000000',
                        P: '#000000',
                        S: '#000000',
                        B: '#000000',
                        SI: '#000000',
                        H: '#000000',
                        BACKGROUND: '#ffffff'
                    }
                }
            });
        }

        // Clear canvas
        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // Draw structure from SMILES (v1.3 with stereo detection)
        function drawStructure(smiles, canvasId, errorElementId) {
            const canvas = document.getElementById(canvasId);
            const errorElement = document.getElementById(errorElementId);

            // Get warning box element
            const warningId = canvasId.replace('-canvas', '-stereo-warning');
            const warningBox = document.getElementById(warningId);

            // Clean input and detect stereochemistry
            const cleanSmiles = smiles ? smiles.trim() : '';
            const hasStereo = cleanSmiles.includes('@');

            // Handle stereochemistry warning
            if (warningBox) {
                if (hasStereo) {
                    warningBox.classList.add('force-visible');
                    warningBox.classList.remove('force-hidden');
                    warningBox.style.display = 'block';
                } else {
                    warningBox.classList.add('force-hidden');
                    warningBox.classList.remove('force-visible');
                    warningBox.style.display = 'none';
                }
            }

            if (!cleanSmiles) {
                clearCanvas(canvasId);
                canvas.classList.remove('error');
                if (errorElement) errorElement.textContent = '';
                canvas.setAttribute('aria-label', 'Empty chemical structure canvas');
                return;
            }

            try {
                SmilesDrawer.parse(cleanSmiles, function(tree) {
                    // Success - draw structure
                    clearCanvas(canvasId);
                    drawer.draw(tree, canvas, 'dark', false);
                    canvas.classList.remove('error');
                    if (errorElement) errorElement.textContent = '';
                    canvas.setAttribute('aria-label', `molecular structure: ${cleanSmiles}`);
                }, function(err) {
                    // Error - show feedback
                    console.error('SMILES parsing error:', err);
                    clearCanvas(canvasId);
                    canvas.classList.add('error');
                    if (errorElement) errorElement.textContent = 'Invalid SMILES notation';
                });
            } catch (error) {
                console.error('Drawing error:', error);
                clearCanvas(canvasId);
                canvas.classList.add('error');
                if (errorElement) errorElement.textContent = 'Error rendering structure';
            }
        }

        // ===== Reagent Small Structure Drawing =====
        let miniDrawer = null;

        function initializeMiniDrawer() {
            miniDrawer = new SmilesDrawer.Drawer({
                width: 150,
                height: 100,
                bondThickness: 1,
                bondLength: 15,
                shortBondLength: 0.8,
                bondSpacing: 3,
                atomVisualization: 'default',
                isomeric: true,
                debug: false,
                terminalCarbons: true,
                explicitHydrogens: false,
                overlapSensitivity: 0.42,
                overlapResolutionIterations: 1,
                compactDrawing: true,
                fontSizeLarge: 8,
                fontSizeSmall: 5,
                padding: 5,
                themes: {
                    dark: {
                        C: '#000000',
                        O: '#000000',
                        N: '#000000',
                        F: '#000000',
                        CL: '#000000',
                        BR: '#000000',
                        I: '#000000',
                        P: '#000000',
                        S: '#000000',
                        B: '#000000',
                        SI: '#000000',
                        H: '#000000',
                        BACKGROUND: '#ffffff'
                    }
                }
            });
        }

        function drawReagentStructure(smiles, canvas) {
            if (!smiles || !canvas) return;
            if (!miniDrawer) initializeMiniDrawer();

            const cleanSmiles = smiles.trim();
            if (!cleanSmiles) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            try {
                SmilesDrawer.parse(cleanSmiles, function(tree) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    miniDrawer.draw(tree, canvas, 'dark', false);
                    console.log('[Reagent Draw] Structure drawn for:', cleanSmiles);
                }, function(err) {
                    console.error('[Reagent Draw] SMILES parsing error:', err);
                });
            } catch (error) {
                console.error('[Reagent Draw] Drawing error:', error);
            }
        }

        // ===== Data Model Updates =====

        function updateStartingMaterialData() {
            reactionPlan.startingMaterial.smiles = document.getElementById('sm-smiles').value;
            reactionPlan.startingMaterial.mw = parseFloat(document.getElementById('sm-mw').value) || 0;
            reactionPlan.startingMaterial.mass = parseFloat(document.getElementById('sm-mass').value) || 0;
            reactionPlan.startingMaterial.cas = document.getElementById('sm-cas').value || '';
        }

        function updateProductData() {
            reactionPlan.product.smiles = document.getElementById('product-smiles').value;
        }

        function updateConditionsData() {
            reactionPlan.conditions.solventName = document.getElementById('solvent-name').value;
            reactionPlan.conditions.solventConc = parseFloat(document.getElementById('solvent-conc').value) || 0;
            reactionPlan.conditions.solventVolume = parseFloat(document.getElementById('solvent-volume').value) || 0;
            reactionPlan.conditions.temperature = document.getElementById('temperature').value;
            reactionPlan.conditions.time = document.getElementById('time').value;
            reactionPlan.conditions.notes = document.getElementById('notes').value;
        }

        // ===== Clear All Data Function =====

        /**
         * Clear all data and reset the application
         * Shows confirmation dialog before proceeding
         */
        function clearAllData() {
            const confirmed = confirm(
                '確定要清空所有資料嗎？此動作無法復原。'
            );

            if (confirmed) {
                try {
                    // Clear LocalStorage
                    localStorage.removeItem('reactionPlanData');
                    console.log('[Clear All] LocalStorage cleared');

                    // Reload page to reset all state
                    window.location.reload();
                } catch (error) {
                    console.error('[Clear All] Error during reset:', error);
                    alert('Error occurred while clearing data. Please try refreshing the page manually.');
                }
            }
        }

        // ===== LocalStorage Persistence Module =====

        /**
         * Save all current form data to localStorage
         */
        function saveToLocalStorage() {
            try {
                // Collect Starting Material data
                const startingMaterial = {
                    cas: document.getElementById('sm-cas').value || '',
                    mw: document.getElementById('sm-mw').value || '',
                    mass: document.getElementById('sm-mass').value || '',
                    smiles: document.getElementById('sm-smiles').value || ''
                };

                // Collect all reagent rows
                const reagents = [];
                const reagentRows = document.querySelectorAll('.reagent-row');
                reagentRows.forEach(row => {
                    const reagentData = {
                        id: row.dataset.reagentId,
                        name: row.querySelector('.reagent-name').value || '',
                        cas: row.querySelector('.reagent-cas').value || '',
                        type: row.querySelector('.reagent-type').value || 'pure-solid',
                        mw: row.querySelector('.reagent-mw').value || '',
                        eq: row.querySelector('.reagent-eq').value || '1.0',
                        mass: row.querySelector('.reagent-mass').value || '',
                        volume: row.querySelector('.reagent-volume').value || '',
                        molarity: row.querySelector('.reagent-molarity').value || '',
                        density: row.querySelector('.reagent-density').value || '',
                        purity: row.querySelector('.reagent-purity').value || '',
                        smiles: row.dataset.smiles || ''
                    };
                    reagents.push(reagentData);
                });

                // Collect Conditions data
                const conditions = {
                    solventName: document.getElementById('solvent-name').value || '',
                    solventConc: document.getElementById('solvent-conc').value || '',
                    temperature: document.getElementById('temperature').value || '',
                    time: document.getElementById('time').value || '',
                    notes: document.getElementById('notes').value || ''
                };

                // Collect Product data
                const product = {
                    smiles: document.getElementById('product-smiles').value || '',
                    cas: document.getElementById('product-cas').value || '',
                    mw: reactionPlan.product.mw || 0,
                    name: reactionPlan.product.name || ''
                };

                // Package all data
                const dataToSave = {
                    startingMaterial,
                    reagents,
                    conditions,
                    product,
                    reagentCounter  // Save the counter to maintain unique IDs
                };

                // Save to localStorage
                localStorage.setItem('reactionPlanData', JSON.stringify(dataToSave));
                console.log('[Auto-Save] Data saved to localStorage');
            } catch (error) {
                console.error('[Auto-Save] Error saving to localStorage:', error);
            }
        }

        /**
         * Load saved data from localStorage and populate form
         * @returns {boolean} - True if data was loaded, false otherwise
         */
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('reactionPlanData');

                if (!savedData) {
                    console.log('[Auto-Restore] No saved data found');
                    return false;
                }

                const data = JSON.parse(savedData);
                console.log('[Auto-Restore] Loading saved data:', data);

                // Restore Starting Material
                if (data.startingMaterial) {
                    document.getElementById('sm-cas').value = data.startingMaterial.cas || '';
                    document.getElementById('sm-mw').value = data.startingMaterial.mw || '';
                    document.getElementById('sm-mass').value = data.startingMaterial.mass || '';
                    document.getElementById('sm-smiles').value = data.startingMaterial.smiles || '';
                }

                // Restore reagentCounter to maintain unique IDs
                if (data.reagentCounter !== undefined) {
                    reagentCounter = data.reagentCounter;
                }

                // Restore Reagents (create rows dynamically)
                if (data.reagents && data.reagents.length > 0) {
                    data.reagents.forEach(reagentData => {
                        // Create new reagent row with basic data
                        const row = addReagentRow(reagentData.name, reagentData.mw, reagentData.eq);

                        // Populate all fields
                        row.querySelector('.reagent-cas').value = reagentData.cas || '';
                        row.querySelector('.reagent-type').value = reagentData.type || 'pure-solid';
                        row.querySelector('.reagent-mw').value = reagentData.mw || '';
                        row.querySelector('.reagent-eq').value = reagentData.eq || '1.0';
                        row.querySelector('.reagent-mass').value = reagentData.mass || '';
                        row.querySelector('.reagent-volume').value = reagentData.volume || '';
                        row.querySelector('.reagent-molarity').value = reagentData.molarity || '';
                        row.querySelector('.reagent-density').value = reagentData.density || '';
                        row.querySelector('.reagent-purity').value = reagentData.purity || '';

                        // Update row's data-type attribute for CSS visibility
                        row.dataset.type = reagentData.type || 'pure-solid';

                        // Update the reagent ID to match saved ID (maintain consistency)
                        row.dataset.reagentId = reagentData.id;

                        // Restore and draw reagent SMILES
                        if (reagentData.smiles) {
                            row.dataset.smiles = reagentData.smiles;
                            const canvas = row.querySelector('.reagent-canvas');
                            if (canvas) {
                                drawReagentStructure(reagentData.smiles, canvas);
                            }
                        }

                        // Update data model
                        const reagentId = reagentData.id;
                        updateReagentInModel(reagentId, row);
                    });
                }

                // Restore Conditions
                if (data.conditions) {
                    document.getElementById('solvent-name').value = data.conditions.solventName || '';
                    document.getElementById('solvent-conc').value = data.conditions.solventConc || '';
                    document.getElementById('temperature').value = data.conditions.temperature || '';
                    document.getElementById('time').value = data.conditions.time || '';
                    document.getElementById('notes').value = data.conditions.notes || '';
                }

                // Restore Product
                if (data.product) {
                    document.getElementById('product-smiles').value = data.product.smiles || '';
                    document.getElementById('product-cas').value = data.product.cas || '';
                    reactionPlan.product.mw = data.product.mw || 0;
                    reactionPlan.product.name = data.product.name || '';
                }

                // Update all data models
                updateStartingMaterialData();
                updateProductData();
                updateConditionsData();

                // Trigger calculations after restoration
                calculateSMMmol();  // This will cascade to reagents and solvent volume

                // Draw restored structures
                if (data.startingMaterial && data.startingMaterial.smiles) {
                    drawStructure(data.startingMaterial.smiles, 'sm-canvas', 'sm-error');
                }
                if (data.product && data.product.smiles) {
                    drawStructure(data.product.smiles, 'product-canvas', 'product-error');
                }

                console.log('[Auto-Restore] Data restoration complete');
                return true;
            } catch (error) {
                console.error('[Auto-Restore] Error loading from localStorage:', error);
                return false;
            }
        }

        // ===== Stoichiometry Calculation Module =====

        // Calculate SM mmol from mass and MW
        function calculateSMMmol() {
            const mass = parseFloat(document.getElementById('sm-mass').value) || 0;
            const mw = parseFloat(document.getElementById('sm-mw').value) || 0;

            if (mass > 0 && mw > 0) {
                // Formula: mmol = (mass in mg / MW) * 1000
                const mmol = (mass / mw);
                reactionPlan.startingMaterial.mmol = mmol;
                document.getElementById('sm-mmol').value = mmol.toFixed(4);

                // Recalculate all reagents when SM mmol changes
                recalculateAllReagents();
                // Recalculate solvent volume when SM mmol changes
                calculateSolventVolume();
            } else {
                reactionPlan.startingMaterial.mmol = 0;
                document.getElementById('sm-mmol').value = '';
                recalculateAllReagents();
                calculateSolventVolume();
            }
        }

        // Calculate required solvent volume from SM mmol and target concentration
        function calculateSolventVolume() {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const targetConc = parseFloat(document.getElementById('solvent-conc').value) || 0;
            const volumeInput = document.getElementById('solvent-volume');

            if (smMmol > 0 && targetConc > 0) {
                // Formula: Volume (mL) = mmol / Molarity (M)
                const volume = smMmol / targetConc;
                volumeInput.value = volume.toFixed(3);

                // Update data model
                reactionPlan.conditions.solventVolume = volume;
            } else {
                volumeInput.value = '';
                reactionPlan.conditions.solventVolume = 0;
            }
        }

        // Calculation dispatcher - routes to appropriate calculation based on reagent type
        function calculateReagent(reagentRow, direction = 'forward') {
            const typeSelect = reagentRow.querySelector('.reagent-type');
            const type = typeSelect ? typeSelect.value : 'pure-solid';

            if (type === 'pure-solid') {
                return direction === 'forward' 
                    ? calculatePureSolidMass(reagentRow) 
                    : calculatePureSolidEquivalents(reagentRow);
            } else if (type === 'pure-liquid') {
                return direction === 'forward' 
                    ? calculatePureLiquidVolume(reagentRow) 
                    : calculatePureLiquidEquivalents(reagentRow);
            } else if (type === 'solution-molarity') {
                return direction === 'forward' 
                    ? calculateMolarityVolume(reagentRow) 
                    : calculateMolarityEquivalents(reagentRow);
            } else if (type === 'solution-density') {
                return direction === 'forward' 
                    ? calculateDensityVolume(reagentRow) 
                    : calculateDensityEquivalents(reagentRow);
            }
        }

        // 1. Pure Solid Calculation (Mass = mmol * MW / Purity)
        function calculatePureSolidMass(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const mw = parseFloat(reagentRow.querySelector('.reagent-mw').value) || 0;
            const eq = parseFloat(reagentRow.querySelector('.reagent-eq').value) || 0;
            const purity = parseFloat(reagentRow.querySelector('.reagent-purity').value) || 100;
            
            const massInput = reagentRow.querySelector('.reagent-mass');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && mw > 0 && eq >= 0 && purity > 0) {
                const targetMmol = smMmol * eq;
                const theoreticalMass = targetMmol * mw; 
                const realMass = theoreticalMass / (purity / 100); 

                mmolDisplay.textContent = targetMmol.toFixed(3);
                massInput.value = realMass.toFixed(2); 

                return { mmol: targetMmol, mass: realMass };
            }
            return { mmol: 0, mass: 0 };
        }

        function calculatePureSolidEquivalents(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const mw = parseFloat(reagentRow.querySelector('.reagent-mw').value) || 0;
            const mass = parseFloat(reagentRow.querySelector('.reagent-mass').value) || 0;
            const purity = parseFloat(reagentRow.querySelector('.reagent-purity').value) || 100;
            
            const eqInput = reagentRow.querySelector('.reagent-eq');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && mw > 0 && mass > 0 && purity > 0) {
                const theoreticalMass = mass * (purity / 100);
                const reagentMmol = theoreticalMass / mw;
                const eq = reagentMmol / smMmol;

                mmolDisplay.textContent = reagentMmol.toFixed(3);
                eqInput.value = eq.toFixed(2);
                return { eq: eq, mmol: reagentMmol };
            }
            return null;
        }

        // 2. Pure Liquid Calculation (Volume = Mass / Density)
        function calculatePureLiquidVolume(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const mw = parseFloat(reagentRow.querySelector('.reagent-mw').value) || 0;
            const eq = parseFloat(reagentRow.querySelector('.reagent-eq').value) || 0;
            const density = parseFloat(reagentRow.querySelector('.reagent-density').value) || 0;
            const purity = parseFloat(reagentRow.querySelector('.reagent-purity').value) || 100;

            const volumeInput = reagentRow.querySelector('.reagent-volume');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && mw > 0 && eq >= 0 && density > 0 && purity > 0) {
                const targetMmol = smMmol * eq;
                const theoreticalMass = targetMmol * mw; // mg
                const realMass = theoreticalMass / (purity / 100); // mg (scaled)
                const volume = realMass / density / 1000; // mL

                mmolDisplay.textContent = targetMmol.toFixed(3);
                volumeInput.value = volume.toFixed(3); // 3 decimal places for mL

                return { mmol: targetMmol, volume: volume };
            }
            return { mmol: 0, volume: 0 };
        }

        function calculatePureLiquidEquivalents(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const mw = parseFloat(reagentRow.querySelector('.reagent-mw').value) || 0;
            const density = parseFloat(reagentRow.querySelector('.reagent-density').value) || 0;
            const purity = parseFloat(reagentRow.querySelector('.reagent-purity').value) || 100;
            const volume = parseFloat(reagentRow.querySelector('.reagent-volume').value) || 0;
            
            const eqInput = reagentRow.querySelector('.reagent-eq');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && mw > 0 && density > 0 && volume > 0) {
                const realMass = volume * density * 1000; // mg
                const theoreticalMass = realMass * (purity / 100);
                const reagentMmol = theoreticalMass / mw;
                const eq = reagentMmol / smMmol;

                mmolDisplay.textContent = reagentMmol.toFixed(3);
                eqInput.value = eq.toFixed(2);
                return { eq: eq, mmol: reagentMmol };
            }
            return null;
        }

        // 3. Solution (Molarity) Calculation
        function calculateMolarityVolume(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const eq = parseFloat(reagentRow.querySelector('.reagent-eq').value) || 0;
            const molarity = parseFloat(reagentRow.querySelector('.reagent-molarity').value) || 0;
            const volumeInput = reagentRow.querySelector('.reagent-volume');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && molarity > 0 && eq >= 0) {
                const reagentMmol = smMmol * eq;
                const volume = reagentMmol / molarity; // mL

                mmolDisplay.textContent = reagentMmol.toFixed(3);
                volumeInput.value = volume.toFixed(3); // 3 decimal places
                return { mmol: reagentMmol, volume: volume };
            }
            return { mmol: 0, volume: 0 };
        }

        function calculateMolarityEquivalents(reagentRow) {
            const smMmol = reactionPlan.startingMaterial.mmol;
            const molarity = parseFloat(reagentRow.querySelector('.reagent-molarity').value) || 0;
            const volume = parseFloat(reagentRow.querySelector('.reagent-volume').value) || 0;
            const eqInput = reagentRow.querySelector('.reagent-eq');
            const mmolDisplay = reagentRow.querySelector('.reagent-mmol');

            if (smMmol > 0 && molarity > 0 && volume > 0) {
                const reagentMmol = molarity * volume;
                const eq = reagentMmol / smMmol;

                mmolDisplay.textContent = reagentMmol.toFixed(3);
                eqInput.value = eq.toFixed(2);
                return { eq: eq, mmol: reagentMmol };
            }
            return null;
        }

        // 4. Solution (Wt%/Density) Calculation - reusing Pure Liquid Logic logic but separating for clarity
        function calculateDensityVolume(reagentRow) {
            // Logic is identical to Pure Liquid: Mass -> Vol via Density, Purity applies to solute
            return calculatePureLiquidVolume(reagentRow);
        }

        function calculateDensityEquivalents(reagentRow) {
            return calculatePureLiquidEquivalents(reagentRow);
        }
        // Recalculate all reagent rows
        function recalculateAllReagents() {
            const reagentRows = document.querySelectorAll('.reagent-row');
            reagentRows.forEach(row => {
                const massInput = row.querySelector('.reagent-mass');
                const volumeInput = row.querySelector('.reagent-volume');

                // Only recalculate if not manually overridden
                if (!massInput.dataset.manualOverride && !volumeInput.dataset.manualOverride) {
                    calculateReagent(row, 'forward');
                }
            });
        }

        // Handle reagent type change
        function handleTypeChange(reagentId, row) {
            const typeSelect = row.querySelector('.reagent-type');
            const type = typeSelect.value;

            // Update data attribute for CSS
            row.dataset.type = type;

            // Clear manual override flags
            row.querySelector('.reagent-mass').dataset.manualOverride = '';
            row.querySelector('.reagent-volume').dataset.manualOverride = '';

            // IMPORTANT: Clear ALL type-specific fields unconditionally when switching
            // This prevents data residue from previous type selections
            row.querySelector('.reagent-mass').value = '';
            row.querySelector('.reagent-volume').value = '';
            row.querySelector('.reagent-molarity').value = '';
            row.querySelector('.reagent-density').value = '';
            row.querySelector('.reagent-purity').value = '';

            // Recalculate with new type
            calculateReagent(row, 'forward');
            updateReagentInModel(reagentId, row);
        }

        // ===== PubChem API Integration Module =====

        /**
         * Fetch compound data from PubChem by CAS number
         * @param {string} cas - CAS registry number (e.g., "50-78-2")
         * @returns {Promise<Object>} - Compound data {mw, name, smiles}
         */
        async function fetchPubChemData(cas) {
            if (!cas || cas.trim() === '') {
                throw new Error('CAS number is required');
            }

            const cleanCas = cas.trim();

            // Construct API URL - explicitly include all SMILES properties
            const apiUrl = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${encodeURIComponent(cleanCas)}/property/MolecularWeight,IUPACName,CanonicalSMILES,IsomericSMILES/JSON`;

            console.log('=== PubChem Fetch Debug ===');
            console.log('CAS Number:', cleanCas);
            console.log('Final Request URL:', apiUrl);

            try {
                const response = await fetch(apiUrl);
                console.log('Response Status:', response.status, response.statusText);

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('CAS not found in PubChem database');
                    }
                    throw new Error(`PubChem API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Full API Response:', JSON.stringify(data, null, 2));

                if (!data.PropertyTable || !data.PropertyTable.Properties || data.PropertyTable.Properties.length === 0) {
                    throw new Error('No compound data found');
                }

                const compound = data.PropertyTable.Properties[0];
                console.log('Compound Object Keys:', Object.keys(compound));
                console.log('Compound data extracted:', compound);

                // Try multiple ways to extract SMILES
                let smiles = '';

                // Method 1: Direct property access
                if (compound.IsomericSMILES) {
                    smiles = compound.IsomericSMILES;
                    console.log('SMILES found via IsomericSMILES property:', smiles);
                } else if (compound.CanonicalSMILES) {
                    smiles = compound.CanonicalSMILES;
                    console.log('SMILES found via CanonicalSMILES property:', smiles);
                } else if (compound.SMILES) {
    smiles = compound.SMILES;
} else {
                    console.error('SMILES not found in compound properties');
                    console.error('Available properties:', Object.keys(compound));
                }

                const result = {
                    mw: parseFloat(compound.MolecularWeight) || 0,
                    name: compound.IUPACName || '',
                    smiles: smiles
                };

                console.log('Final parsed result:', result);
                console.log('=== End Debug ===');
                return result;
            } catch (error) {
                console.error('PubChem fetch error:', error);
                throw error;
            }
        }

        /**
         * Populate Starting Material fields with PubChem data
         * @param {Object} data - {mw, name, smiles}
         */
        function populateStartingMaterialFromPubChem(data) {
            console.log('[SM Populate] Starting with data:', data);

            // Fill MW (ensure it's a number before calling toFixed)
            const mwValue = parseFloat(data.mw) || 0;
            document.getElementById('sm-mw').value = mwValue.toFixed(2);
            console.log('[SM Populate] MW set to:', mwValue.toFixed(2));

            // Fill SMILES - with validation and fallback
            const smilesInput = document.getElementById('sm-smiles');
            if (data.smiles && data.smiles.trim() !== '') {
                smilesInput.value = data.smiles.trim();
                console.log('[SM Populate] SMILES set to:', data.smiles.trim());
            } else {
                smilesInput.value = '';
                console.error('[SM Populate] SMILES not found or empty in API data');
                alert('Warning: SMILES data not available from PubChem for this compound');
            }

            // Update data model
            updateStartingMaterialData();

            // Auto-draw structure - force immediate drawing
            const smilesValue = smilesInput.value;
            if (smilesValue && smilesValue.trim() !== '') {
                console.log('[SM Populate] Drawing structure with SMILES:', smilesValue);
                drawStructure(smilesValue, 'sm-canvas', 'sm-error');
            } else {
                console.warn('[SM Populate] Skipping structure drawing - no valid SMILES');
            }

            // Recalculate if mass is already entered
            if (document.getElementById('sm-mass').value) {
                calculateSMMmol();
            }

            console.log('[SM Populate] Population complete');
        }

        /**
         * Populate Product fields with PubChem data
         * @param {Object} data - {mw, name, smiles}
         */
        function populateProductFromPubChem(data) {
            console.log('[Product Populate] Starting with data:', data);

            // Fill SMILES - with validation
            const smilesInput = document.getElementById('product-smiles');
            if (data.smiles && data.smiles.trim() !== '') {
                smilesInput.value = data.smiles.trim();
                console.log('[Product Populate] SMILES set to:', data.smiles.trim());
            } else {
                smilesInput.value = '';
                console.error('[Product Populate] SMILES not found or empty in API data');
                alert('Warning: SMILES data not available from PubChem for this compound');
            }

            // Update data model
            reactionPlan.product.smiles = smilesInput.value;
            reactionPlan.product.mw = parseFloat(data.mw) || 0;
            reactionPlan.product.name = data.name || '';

            // Auto-draw structure
            const smilesValue = smilesInput.value;
            if (smilesValue && smilesValue.trim() !== '') {
                console.log('[Product Populate] Drawing structure with SMILES:', smilesValue);
                drawStructure(smilesValue, 'product-canvas', 'product-error');
            }

            console.log('[Product Populate] Population complete');
        }

        /**
         * Populate Reagent fields with PubChem data
         * @param {Object} data - {mw, name, smiles}
         * @param {HTMLElement} row - Reagent row element
         * @param {string} reagentId - Reagent ID (e.g., 'r1')
         */
        function populateReagentFromPubChem(data, row, reagentId) {
            console.log(`[Reagent ${reagentId} Populate] Starting with data:`, data);

            // Fill Name (IUPAC) - with validation
            const nameInput = row.querySelector('.reagent-name');
            if (data.name && data.name.trim() !== '') {
                nameInput.value = data.name.trim();
                console.log(`[Reagent ${reagentId} Populate] Name set to:`, data.name.trim());
            } else {
                nameInput.value = 'Unknown compound';
                console.warn(`[Reagent ${reagentId} Populate] Name not found, using default`);
            }

            // Fill MW (ensure it's a number before calling toFixed)
            const mwInput = row.querySelector('.reagent-mw');
            const mwValue = parseFloat(data.mw) || 0;
            mwInput.value = mwValue.toFixed(2);
            console.log(`[Reagent ${reagentId} Populate] MW set to:`, mwValue.toFixed(2));

            // Validate SMILES data (for logging purposes)
            if (!data.smiles || data.smiles.trim() === '') {
                console.warn(`[Reagent ${reagentId} Populate] SMILES not available from PubChem`);
            } else {
                console.log(`[Reagent ${reagentId} Populate] SMILES available:`, data.smiles);
            }

            // Update data model
            updateReagentInModel(reagentId, row);

            // Trigger calculation (if SM data exists)
            if (reactionPlan.startingMaterial.mmol > 0) {
                const massInput = row.querySelector('.reagent-mass');
                const volumeInput = row.querySelector('.reagent-volume');
                massInput.dataset.manualOverride = '';
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
            }

            console.log(`[Reagent ${reagentId} Populate] Population complete`);
        }

        /**
         * Handle SM Fetch button click
         */
        async function handleSMFetch() {
            const casInput = document.getElementById('sm-cas');
            const fetchBtn = document.getElementById('sm-fetch-btn');
            const cas = casInput.value.trim();

            console.log('[SM Fetch] Starting fetch for CAS:', cas);

            if (!cas) {
                alert('Please enter a CAS number');
                return;
            }

            // Set loading state
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'Loading...';
            fetchBtn.classList.add('loading');

            try {
                console.log('[SM Fetch] Calling fetchPubChemData...');
                const data = await fetchPubChemData(cas);
                console.log('[SM Fetch] Data received:', data);

                console.log('[SM Fetch] Calling populateStartingMaterialFromPubChem...');
                populateStartingMaterialFromPubChem(data);
                saveToLocalStorage();

                // Success feedback
                fetchBtn.textContent = 'Fetched!';
                console.log('[SM Fetch] Fetch successful!');
                setTimeout(() => {
                    fetchBtn.textContent = 'Fetch';
                }, 1500);
            } catch (error) {
                console.error('[SM Fetch] Error occurred:', error);
                alert(`Error: ${error.message}`);
                // Reset button text immediately on error
                fetchBtn.textContent = 'Fetch';
            } finally {
                // ALWAYS reset button state (success or failure)
                fetchBtn.disabled = false;
                fetchBtn.classList.remove('loading');
            }
        }

        /**
         * Handle Product Fetch button click
         */
        async function handleProductFetch() {
            const casInput = document.getElementById('product-cas');
            const fetchBtn = document.getElementById('product-fetch-btn');
            const cas = casInput.value.trim();

            console.log('[Product Fetch] Starting fetch for CAS:', cas);

            if (!cas) {
                alert('Please enter a CAS number');
                return;
            }

            // Set loading state
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'Loading...';
            fetchBtn.classList.add('loading');

            try {
                console.log('[Product Fetch] Calling fetchPubChemData...');
                const data = await fetchPubChemData(cas);
                console.log('[Product Fetch] Data received:', data);

                console.log('[Product Fetch] Calling populateProductFromPubChem...');
                populateProductFromPubChem(data);

                // Update CAS in data model
                reactionPlan.product.cas = cas;
                saveToLocalStorage();

                // Success feedback
                fetchBtn.textContent = 'Fetched!';
                console.log('[Product Fetch] Fetch successful!');
                setTimeout(() => {
                    fetchBtn.textContent = 'Fetch';
                }, 1500);
            } catch (error) {
                console.error('[Product Fetch] Error occurred:', error);
                alert(`Error: ${error.message}`);
                // Reset button text immediately on error
                fetchBtn.textContent = 'Fetch';
            } finally {
                // ALWAYS reset button state (success or failure)
                fetchBtn.disabled = false;
                fetchBtn.classList.remove('loading');
            }
        }

        /**
         * Handle Reagent Fetch button click
         * @param {string} reagentId - Reagent ID (e.g., 'r1')
         */
        async function handleReagentFetch(row) {
            // 1. 變數定義在最上面，確保終於區塊(finally)一定抓得到按鈕
            const fetchBtn = row.querySelector('.reagent-fetch-btn');
            const casInput = row.querySelector('.reagent-cas');
            const nameInput = row.querySelector('.reagent-name');
            const mwInput = row.querySelector('.reagent-mw');
            
            // 取得輸入的 CAS
            const cas = casInput.value.trim();

            if (!cas) {
                alert('Please enter a CAS number');
                return;
            }

            try {
                // 2. 鎖定按鈕，變更文字為 Loading...
                fetchBtn.disabled = true;
                fetchBtn.textContent = 'Loading...';
                fetchBtn.classList.add('loading');

                // 3. 呼叫 PubChem API (包含 SMILES)
                const response = await fetch(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${cas}/property/MolecularWeight,IUPACName,CanonicalSMILES,IsomericSMILES/JSON`);

                if (!response.ok) {
                    throw new Error('CAS not found in PubChem database');
                }

                const data = await response.json();

                if (data.PropertyTable && data.PropertyTable.Properties.length > 0) {
                    const props = data.PropertyTable.Properties[0];

                    // 填入數據
                    mwInput.value = props.MolecularWeight;
                    nameInput.value = props.IUPACName;

                    // 觸發重新計算
                    calculateReagent(row, 'forward');
                    updateReagentInModel(row.dataset.reagentId, row);

                    // 獲取 SMILES 並繪製結構
                    const smiles = props.IsomericSMILES || props.CanonicalSMILES || '';
                    if (smiles) {
                        const canvas = row.querySelector('.reagent-canvas');
                        if (canvas) {
                            drawReagentStructure(smiles, canvas);
                            // 保存 SMILES 到 row 的 data 屬性
                            row.dataset.smiles = smiles;
                        }
                    }

                    saveToLocalStorage();
                } else {
                    throw new Error('No data found for this CAS');
                }

            } catch (error) {
                console.error('Fetch error:', error);
                // 這裡會跳出 Alert，測試腳本會抓到這個
                alert(error.message);
            } finally {
                // 4. 【關鍵修復】無論成功還是失敗，這裡一定會執行！
                // 強制把按鈕變回原狀
                if (fetchBtn) {
                    fetchBtn.disabled = false;
                    fetchBtn.textContent = 'Fetch';
                    fetchBtn.classList.remove('loading');
                }
            }
        }

        // ===== Dynamic Reagent Table Module =====

        // Add new reagent row
        function addReagentRow(reagentName = '', mw = '', eq = '1.0') {
            reagentCounter++;
            const reagentId = `r${reagentCounter}`;
            const container = document.getElementById('reagent-cards');

            const row = document.createElement('div');
            row.className = 'compound-card reagent-card reagent-row';
            row.dataset.reagentId = reagentId;
            row.dataset.type = 'pure-solid';  // Default type

            row.innerHTML = `
                <div class="card-header">
                    <input type="text" class="reagent-name" placeholder="Reagent name" value="${reagentName}">
                    <button class="remove-btn" onclick="removeReagentRow('${reagentId}')" aria-label="Remove reagent">✕</button>
                </div>
                <canvas class="reagent-canvas compound-canvas" width="150" height="150" data-reagent-id="${reagentId}" role="img" aria-label="Reagent molecular structure"></canvas>
                <div class="card-field">
                    <label>CAS No.</label>
                    <div class="cas-input-group">
                        <input type="text" class="reagent-cas" placeholder="CAS No.">
                        <button class="reagent-fetch-btn fetch-btn" aria-label="Fetch data from PubChem">Fetch</button>
                    </div>
                </div>
                <div class="card-field">
                    <label>Type</label>
                    <select class="reagent-type">
                        <option value="pure-solid" selected>Pure Solid</option>
                        <option value="pure-liquid">Pure Liquid</option>
                        <option value="solution-molarity">Solution (M)</option>
                        <option value="solution-density">Solution (Wt%)</option>
                    </select>
                </div>
                <div class="card-field">
                    <label>MW (g/mol)</label>
                    <input type="number" class="reagent-mw" step="0.01" min="0" placeholder="MW" value="${mw}">
                </div>
                <div class="card-field">
                    <label>Equivalents</label>
                    <input type="number" class="reagent-eq" step="0.1" min="0" placeholder="Eq" value="${eq}">
                </div>
                <div class="card-field">
                    <label>Amount (mmol)</label>
                    <span class="reagent-mmol">-</span>
                </div>
                <div class="card-field reagent-mass-field">
                    <label>Mass (mg)</label>
                    <input type="number" class="reagent-mass" step="0.1" min="0" placeholder="Mass">
                </div>
                <div class="card-field reagent-volume-field">
                    <label>Volume (mL)</label>
                    <input type="number" class="reagent-volume" step="0.01" min="0" placeholder="Volume">
                </div>
                <div class="card-field reagent-molarity-field">
                    <label>Molarity (M)</label>
                    <input type="number" class="reagent-molarity" step="0.01" min="0" placeholder="M">
                </div>
                <div class="card-field reagent-density-field">
                    <label>Density (g/mL)</label>
                    <input type="number" class="reagent-density" step="0.01" min="0" placeholder="Density">
                </div>
                <div class="card-field reagent-purity-field">
                    <label>Purity (%)</label>
                    <input type="number" class="reagent-purity" step="0.1" min="0" max="100" placeholder="%" value="100">
                </div>
            `;

            container.appendChild(row);

            // Add event listeners for calculation
            const typeSelect = row.querySelector('.reagent-type');
            const mwInput = row.querySelector('.reagent-mw');
            const eqInput = row.querySelector('.reagent-eq');
            const massInput = row.querySelector('.reagent-mass');
            const volumeInput = row.querySelector('.reagent-volume');
            const molarityInput = row.querySelector('.reagent-molarity');
            const densityInput = row.querySelector('.reagent-density');
            const purityInput = row.querySelector('.reagent-purity');
            const nameInput = row.querySelector('.reagent-name');
            const casInput = row.querySelector('.reagent-cas');

            // Type dropdown listener
            typeSelect.addEventListener('change', () => {
                handleTypeChange(reagentId, row);
                saveToLocalStorage();
            });

            // MW or Eq change → Calculate (forward)
            mwInput.addEventListener('input', () => {
                massInput.dataset.manualOverride = '';
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            eqInput.addEventListener('input', () => {
                massInput.dataset.manualOverride = '';
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // Mass change → Calculate equivalents (reverse)
            massInput.addEventListener('input', () => {
                if (massInput.value) {
                    massInput.dataset.manualOverride = 'true';
                    calculateReagent(row, 'reverse');
                }
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // Volume change → Calculate equivalents (reverse)
            volumeInput.addEventListener('input', () => {
                if (volumeInput.value) {
                    volumeInput.dataset.manualOverride = 'true';
                    calculateReagent(row, 'reverse');
                }
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // Molarity change → Calculate volume (forward)
            molarityInput.addEventListener('input', () => {
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // Density change → Calculate volume (forward)
            densityInput.addEventListener('input', () => {
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // Purity change → Calculate volume (forward)
            purityInput.addEventListener('input', () => {
                volumeInput.dataset.manualOverride = '';
                calculateReagent(row, 'forward');
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            nameInput.addEventListener('input', () => {
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // CAS input listener
            casInput.addEventListener('input', () => {
                updateReagentInModel(reagentId, row);
                saveToLocalStorage();
            });

            // Fetch button listener
            const fetchBtn = row.querySelector('.reagent-fetch-btn');
            fetchBtn.addEventListener('click', () => {
                handleReagentFetch(row);
            });

            // Allow Enter key in CAS input
            casInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleReagentFetch(row);
                }
            });

            // Add to data model
            addReagentToModel(reagentId, reagentName, mw, eq);

            // Calculate initial values if we have SM data
            if (reactionPlan.startingMaterial.mmol > 0) {
                calculateReagent(row, 'forward');
            }

            return row;
        }

        // Remove reagent row
        function removeReagentRow(reagentId) {
            const row = document.querySelector(`[data-reagent-id="${reagentId}"]`);
            if (row) {
                row.remove();
                removeReagentFromModel(reagentId);
                saveToLocalStorage();
            }
        }

        // Data model management for reagents
        function addReagentToModel(id, name = '', mw = 0, eq = 1.0, type = 'pure') {
            reactionPlan.reagents.push({
                id: id,
                name: name,
                type: type,
                mw: parseFloat(mw) || 0,
                eq: parseFloat(eq) || 1.0,
                mmol: 0,
                mass: 0,
                volume: 0,
                molarity: 0,
                density: 0,
                purity: 0,
                cas: ''
            });
        }

        function removeReagentFromModel(id) {
            const index = reactionPlan.reagents.findIndex(r => r.id === id);
            if (index !== -1) {
                reactionPlan.reagents.splice(index, 1);
            }
        }

        function updateReagentInModel(id, row) {
            const reagent = reactionPlan.reagents.find(r => r.id === id);
            if (reagent) {
                const typeSelect = row.querySelector('.reagent-type');

                // Common fields
                reagent.name = row.querySelector('.reagent-name').value;
                reagent.type = typeSelect ? typeSelect.value : 'pure';
                reagent.mw = parseFloat(row.querySelector('.reagent-mw').value) || 0;
                reagent.eq = parseFloat(row.querySelector('.reagent-eq').value) || 0;

                const mmolText = row.querySelector('.reagent-mmol').textContent;
                reagent.mmol = mmolText !== '-' ? parseFloat(mmolText) : 0;

                reagent.cas = row.querySelector('.reagent-cas').value || '';

                // Type-specific fields
                if (reagent.type === 'pure') {
                    reagent.mass = parseFloat(row.querySelector('.reagent-mass').value) || 0;
                    reagent.volume = 0;
                    reagent.molarity = 0;
                    reagent.density = 0;
                    reagent.purity = 0;
                } else if (reagent.type === 'solution-molarity') {
                    reagent.volume = parseFloat(row.querySelector('.reagent-volume').value) || 0;
                    reagent.molarity = parseFloat(row.querySelector('.reagent-molarity').value) || 0;
                    reagent.mass = 0;
                    reagent.density = 0;
                    reagent.purity = 0;
                } else if (reagent.type === 'solution-density') {
                    reagent.volume = parseFloat(row.querySelector('.reagent-volume').value) || 0;
                    reagent.density = parseFloat(row.querySelector('.reagent-density').value) || 0;
                    reagent.purity = parseFloat(row.querySelector('.reagent-purity').value) || 0;
                    reagent.mass = 0;
                    reagent.molarity = 0;
                }
            }
        }

        // ===== Example Data Loader =====

        function loadExampleData() {
            // Load Starting Material
            document.getElementById('sm-smiles').value = 'CC(=O)OC1=CC=CC=C1C(=O)O';
            document.getElementById('sm-mw').value = '180.16';
            document.getElementById('sm-mass').value = '100';

            // Load Product
            document.getElementById('product-smiles').value = 'O=C(O)c1ccccc1O';

            // Load Conditions
            document.getElementById('solvent-name').value = 'THF';
            document.getElementById('solvent-conc').value = '0.1';
            // Volume will auto-calculate
            document.getElementById('temperature').value = 'rt';
            document.getElementById('time').value = '2 h';
            document.getElementById('notes').value = 'Aspirin hydrolysis example - demonstrates base hydrolysis followed by acidification';

            // Update data model
            updateStartingMaterialData();
            updateProductData();
            updateConditionsData();

            // Render structures
            drawStructure(document.getElementById('sm-smiles').value, 'sm-canvas', 'sm-error');
            drawStructure(document.getElementById('product-smiles').value, 'product-canvas', 'product-error');

            // Calculate SM mmol
            calculateSMMmol();

            // Load example reagents
            addReagentRow('NaOH', '40.00', '2.0');
            addReagentRow('HCl', '36.46', '2.0');
        }

        // ===== Event Handlers & Initialization =====

        function initializeEventListeners() {
            // SMILES inputs with debouncing
            const smSmilesInput = document.getElementById('sm-smiles');
            const productSmilesInput = document.getElementById('product-smiles');

            const debouncedDrawSM = debounce(() => {
                drawStructure(smSmilesInput.value, 'sm-canvas', 'sm-error');
                updateStartingMaterialData();
                saveToLocalStorage();
            }, 500);

            const debouncedDrawProduct = debounce(() => {
                drawStructure(productSmilesInput.value, 'product-canvas', 'product-error');
                updateProductData();
                saveToLocalStorage();
            }, 500);

            smSmilesInput.addEventListener('input', debouncedDrawSM);
            productSmilesInput.addEventListener('input', debouncedDrawProduct);

            // Also trigger on blur for immediate feedback
            smSmilesInput.addEventListener('blur', () => {
                drawStructure(smSmilesInput.value, 'sm-canvas', 'sm-error');
                updateStartingMaterialData();
                saveToLocalStorage();
            });
            productSmilesInput.addEventListener('blur', () => {
                drawStructure(productSmilesInput.value, 'product-canvas', 'product-error');
                updateProductData();
                saveToLocalStorage();
            });

            // Starting material calculations
            document.getElementById('sm-mass').addEventListener('input', () => {
                calculateSMMmol();
                updateStartingMaterialData();
                saveToLocalStorage();
            });

            document.getElementById('sm-mw').addEventListener('input', () => {
                calculateSMMmol();
                updateStartingMaterialData();
                saveToLocalStorage();
            });

            document.getElementById('sm-cas').addEventListener('input', () => {
                updateStartingMaterialData();
                saveToLocalStorage();
            });

            // Starting Material PubChem fetch
            document.getElementById('sm-fetch-btn').addEventListener('click', handleSMFetch);

            // Allow Enter key in CAS input to trigger fetch
            document.getElementById('sm-cas').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSMFetch();
                }
            });

            // Product PubChem fetch
            document.getElementById('product-fetch-btn').addEventListener('click', handleProductFetch);

            // Allow Enter key in Product CAS input to trigger fetch
            document.getElementById('product-cas').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleProductFetch();
                }
            });

            // Product CAS input change listener (for auto-save)
            document.getElementById('product-cas').addEventListener('input', () => {
                reactionPlan.product.cas = document.getElementById('product-cas').value;
                saveToLocalStorage();
            });

            // Clear All button
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);

            // Add reagent button
            document.getElementById('add-reagent').addEventListener('click', () => {
                addReagentRow();
                saveToLocalStorage();
            });

            // Conditions inputs
            document.getElementById('solvent-name').addEventListener('input', () => {
                updateConditionsData();
                saveToLocalStorage();
            });
            document.getElementById('solvent-conc').addEventListener('input', () => {
                calculateSolventVolume();
                updateConditionsData();
                saveToLocalStorage();
            });
            document.getElementById('temperature').addEventListener('input', () => {
                updateConditionsData();
                saveToLocalStorage();
            });
            document.getElementById('time').addEventListener('input', () => {
                updateConditionsData();
                saveToLocalStorage();
            });
            document.getElementById('notes').addEventListener('input', () => {
                updateConditionsData();
                saveToLocalStorage();
            });

            // Export button
            document.getElementById('exportBtn').addEventListener('click', () => {
                window.print();
            });
        }

        // DOM Content Loaded - Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Digital Reaction Planner initializing...');

            // Initialize smiles-drawer
            initializeSmilesDrawer();

            // Set up event listeners
            initializeEventListeners();

            // Try to load saved data first, fallback to example data
            const dataLoaded = loadFromLocalStorage();

            if (!dataLoaded) {
                // Only load example data if no saved data exists
                loadExampleData();
            }

            console.log('Digital Reaction Planner ready!');
        });
    </script>
</body>
</html>
